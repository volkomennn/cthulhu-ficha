<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investigador Call of Cthulhu</title>
    <style>
        /* ANIMA√á√ïES DE ENTRADA */
        @keyframes fadeInTotal {
            from { opacity: 0; filter: blur(10px); }
            to { opacity: 1; filter: blur(0); }
        }

        @keyframes subirEntrada {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .val-auto {
    background: rgba(255, 255, 255, 0.05) !important;
    color: #777 !important;
    font-style: italic;
    cursor: not-allowed;
}

        /* EST√âTICA NOIR EXUBERANTE */
        body { 
            font-family: 'Garamond', serif; 
            background-color: #050505; 
            background-image: radial-gradient(circle at center, #1a1a1a 0%, #050505 100%);
            color: #f2f2f2; 
            padding: 20px; 
            line-height: 1.6; 
            overflow-x: hidden;
            opacity: 0;
            animation: fadeInTotal 2s ease-out forwards;
        }

        /* FUNDO DE QUADRADOS SUBINDO */
        #bg-particles {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        .square {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            bottom: -50px;
            animation: sobeQuadradinho 12s linear infinite;
        }

        @keyframes sobeQuadradinho {
            0% { transform: translateY(0) rotate(0deg); opacity: 0; }
            10% { opacity: 0.2; }
            90% { opacity: 0.2; }
            100% { transform: translateY(-120vh) rotate(720deg); opacity: 0; }
        }

        /* PLAYER E GIF */
        .music-player-container {
            position: fixed;
            top: 20px; 
            left: 20px; 
            z-index: 1000;
            background: rgba(0,0,0,0.95);
            padding: 30px; 
            border: 2px solid #333; 
            text-align: center;
            box-shadow: 0 0 40px rgba(0,0,0,1);
            animation: subirEntrada 1.5s ease-out 0.8s forwards;
            opacity: 0;
            width: 260px;
        }

        .gif-musica {
            width: 220px; 
            margin-bottom: 20px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            filter: grayscale(100%) contrast(1.2);
            border: 1px solid #222;
        }

        /* CONTAINER DA FICHA */
        .container { 
            max-width: 950px; 
            margin: 40px auto; 
            background: #0d0d0d; 
            padding: 40px; 
            border: 1px solid #2a2a2a; 
            box-shadow: 0 0 60px rgba(0,0,0,1), inset 0 0 20px rgba(255,255,255,0.02);
            position: relative;
            z-index: 1;
        }

        .container::before {
            content: "";
            position: absolute;
            top: 10px; left: 10px; right: 10px; bottom: 10px;
            border: 1px solid #1a1a1a;
            pointer-events: none;
        }

        .logo-projeto { 
            display: block; 
            margin: 0 auto 30px; 
            width: 160px; 
            height: 160px; 
            object-fit: cover; 
            border-radius: 50%; 
            filter: brightness(1.1) contrast(1.1);
            border: 3px solid #222;
            padding: 5px; 
            background: linear-gradient(145deg, #111, #000);
            box-shadow: 0 0 20px rgba(0,0,0,0.8), inset 0 0 10px rgba(255,255,255,0.05);
        }

        h1, h2, h3 { 
            text-align: center; 
            color: #ffffff; 
            text-transform: uppercase; 
            letter-spacing: 5px; 
            font-weight: 300;
            margin-bottom: 25px;
            border-bottom: 1px solid #333;
            display: block;
            padding-bottom: 10px;
        }

        .section { 
            margin-bottom: 35px; 
            padding: 25px; 
            border: 1px solid #222; 
            background: rgba(20, 20, 20, 0.8);
            box-shadow: 5px 5px 15px rgba(0,0,0,0.5);
        }

        .header-ficha { display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-start; }
        
        .foto-wrapper {
            position: sticky;
            top: 20px;
            z-index: 10;
        }

        .foto-container { 
            width: 200px; height: 250px; background: #000; border: 1px solid #333; 
            position: relative; cursor: pointer; overflow: hidden; display: flex; 
            align-items: center; justify-content: center; transition: 0.5s;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        .foto-container:hover { border-color: #fff; }
        .foto-container img { width: 100%; height: 100%; object-fit: cover; }
        .foto-placeholder { text-align: center; color: #444; font-size: 0.7em; letter-spacing: 2px; }

        .info-pessoais { flex: 1; display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; }
        .field { display: flex; flex-direction: column; }
        label { font-size: 0.7em; margin-bottom: 6px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        
        input { 
            background: #000; color: #913a3a; border: 1px solid #222; 
            padding: 10px; border-radius: 0; font-family: 'Courier New', monospace;
            transition: 0.3s;
        }
        input:focus { border-color: #555; outline: none; background: #050505; }

        button { 
            cursor: pointer; background: linear-gradient(180deg, #333 0%, #111 100%); 
            color: #bbb; border: 1px solid #444; padding: 12px 18px; 
            text-transform: uppercase; font-size: 0.7em; letter-spacing: 2px; transition: 0.3s; 
        }
        button:hover { background: #fff; color: #000; border-color: #fff; box-shadow: 0 0 15px rgba(255,255,255,0.2); }

        .weapon-table, .pericias-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.8em; }
        .weapon-table th, .pericias-table th { background: #151515; color: #888; text-transform: uppercase; padding: 10px; border: 1px solid #222; font-weight: normal; letter-spacing: 1px; }
        .weapon-table td, .pericias-table td { border: 1px solid #222; padding: 5px; background: #0a0a0a; }
        .weapon-table input, .pericias-table input { width: 90%; border: none; background: transparent; padding: 5px; color: #eee; text-align: center; }
        .val-auto { color: #555 !important; }

        /* BOT√ÉO REMOVER ARMA */
        .btn-remove-weapon { background: #300; color: #fff; border: none; padding: 2px 8px; cursor: pointer; transition: 0.3s; }
        .btn-remove-weapon:hover { background: #f00; }

        .grid-pericias { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }

        .dice-roller { background: #0a0a0a; border: 1px solid #222; padding: 25px; margin-bottom: 30px; text-align: center; }
        .dice-display { margin-top: 15px; font-family: 'Courier New', monospace; font-size: 1.3em; color: #fff; background: #000; padding: 15px; border: 1px solid #1a1a1a; }

        .grid-atributos { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        .attr-card { background: #0f0f0f; padding: 20px; border: 1px solid #222; text-align: center; position: relative; }
        .sub-vals { font-size: 0.7em; color: #555; margin-top: 12px; border-top: 1px solid #1a1a1a; padding-top: 8px; }
        
        .status-container-complex { display: flex; flex-direction: column; gap: 20px; margin-bottom: 30px; }
        .bar-wrapper { background: #050505; border: 1px solid #222; padding: 15px; position: relative; }
        .bar-info { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.8em; letter-spacing: 1px; }
        .progress-bg { background: #111; height: 12px; border: 1px solid #000; width: 100%; position: relative; }
        .progress-fill { height: 100%; transition: width 0.4s ease; }
        
        #fill-PV { background: linear-gradient(90deg, #600, #f00); box-shadow: 0 0 10px rgba(255,0,0,0.3); }
        #fill-SAN { background: linear-gradient(90deg, #004, #06f); box-shadow: 0 0 10px rgba(0,100,255,0.3); }
        #fill-MAG { background: linear-gradient(90deg, #303, #a0a); box-shadow: 0 0 10px rgba(160,0,160,0.3); }

        .bar-controls { display: flex; align-items: center; gap: 5px; margin-top: 10px; justify-content: center; }
        .btn-ctrl { padding: 2px 8px; font-size: 10px; min-width: 35px; }

        .status-derivados { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin-top: 20px; }
        .status-box { background: linear-gradient(145deg, #111, #050505); padding: 15px; border: 1px solid #2a2a2a; min-width: 110px; text-align: center; }
        .result-box { color: #fff; font-size: 1.5em; font-weight: 300; display: block; margin-top: 5px; }

        /* OVERLAY CORRIGIDO PARA ACOMPANHAR O SCROLL (FIXED NO VIEWPORT) */
        #result-overlay {
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%) scale(0);
            z-index: 10000; 
            text-align: center; 
            pointer-events: none;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: 100%;
        }
        #result-overlay.active { transform: translate(-50%, -50%) scale(1.8); }
        .res-title { font-size: 3rem; background: #fff; color: #000; padding: 5px 30px; border: 4px double #000; display: inline-block; }
        .res-detail { font-size: 1rem; color: #fff; background: #000; padding: 5px 15px; border: 1px solid #fff; margin-top: 10px; display: block; margin-left: auto; margin-right: auto; max-width: fit-content; }
    </style>
</head>
<body>

<div id="bg-particles"></div>

<div class="music-player-container">
    <img src="https://c.tenor.com/2qFbEpeTPkMAAAAC/tenor.gif" class="gif-musica" alt="Musica">
    <div style="font-size: 0.9em; color: #fff; margin-bottom: 15px; font-family: monospace; letter-spacing: 1px;">HIP SHOP</div>
    
    <audio id="bgMusic" loop>
        <source src="DELTARUNE OST   Rouxls Kaard Shop Hip Shop EXTENDED - Franti≈°ek D (youtube).mp3">
    </audio>

    <div class="bar-controls">
        <button class="btn-ctrl" style="padding: 12px 25px; font-size: 14px;" onclick="document.getElementById('bgMusic').play()">‚ñ∂ PLAY</button>
        <button class="btn-ctrl" style="padding: 12px 25px; font-size: 14px;" onclick="document.getElementById('bgMusic').pause()">‚Ö° PAUSE</button>
    </div>
    <div style="margin-top: 20px; padding: 0 10px;">
        <input type="range" id="volSlider" min="0" max="1" step="0.01" value="0.1" oninput="document.getElementById('bgMusic').volume = this.value" style="width: 100%; cursor: pointer; filter: grayscale(1);">
        <label style="font-size: 10px; color: #666; display: block; margin-top: 5px;">VOLUME MASTER</label>
    </div>
</div>

<div id="result-overlay">
    <p id="overlay-title" class="res-title"></p>
    <p id="overlay-detail" class="res-detail"></p>
</div>

<div class="container">
    <img src="https://i.pinimg.com/736x/71/8a/d9/718ad93c88c10dea945392bfa43ed220.jpg" alt="Logo CoC" class="logo-projeto">
    <h1>Investigador Call of Cthulhu</h1>

    <div class="section">
        <div class="header-ficha">
            <div class="foto-wrapper">
                <div class="field" style="align-items: center;">
                    <div class="foto-container" onclick="document.getElementById('fileInput').click()">
                        <div class="foto-placeholder" id="placeholderTxt">REGISTRO VISUAL<br>CLIQUE PARA INSERIR</div>
                        <img id="charPhoto" src="" style="display:none;">
                        <input type="file" id="fileInput" hidden accept="image/*" onchange="carregarFoto(event)">
                    </div>
                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                        <button onclick="removerFoto()" style="padding: 5px 10px; font-size: 9px; background: #300;">REMOVER</button>
                        <button id="btnDesfazer" onclick="desfazerFoto()" style="padding: 5px 10px; font-size: 9px; opacity: 0.5;" disabled>‚Ü© VOLTAR</button>
                    </div>
                </div>
            </div>

            <div class="info-pessoais">
                <div class="field"><label>Nome</label><input type="text"></div>
                <div class="field"><label>Jogador</label><input type="text"></div>
                <div class="field"><label>Ocupa√ß√£o</label><input type="text"></div>
                <div class="field"><label>Idade</label><input type="number" id="idade" oninput="atualizarTudo()" value="25"></div>
                <div class="field"><label>G√™nero</label><input type="text"></div>
                <div class="field"><label>Resid√™ncia</label><input type="text"></div>
                <div class="field"><label>Local de Nasc.</label><input type="text"></div>
            </div>
        </div>
    </div>

    <div class="dice-roller">
        <label style="color: #666; letter-spacing: 2px;">MECANISMO DE PROBABILIDADE</label><br><br>
        <input type="text" id="diceInput" placeholder="Ex: 3d6">
        <button onclick="rollCustomDice()">EXECUTAR ROLAGEM</button>
        <div id="diceDisplay" class="dice-display">AGUARDANDO...</div>
    </div>

    <div class="section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin:0; border:none;">Atributos Base</h2>
            <button onclick="gerarTodosAtributos()" style="font-size: 0.6em; padding: 5px 10px;">AUTO-GERAR</button>
        </div>
        <div id="attrContainer" class="grid-atributos"></div>
    </div>

    <div class="section">
        <h3>Sinais Vitais e Ps√≠quicos</h3>
        <div class="status-container-complex">
            <div class="bar-wrapper">
                <div class="bar-info">
                    <span>PONTOS DE VIDA (PV)</span>
                    <span id="txt-PV">0 / 0</span>
                </div>
                <div class="progress-bg"><div id="fill-PV" class="progress-fill" style="width: 100%"></div></div>
                <div class="bar-controls">
                    <button class="btn-ctrl" onclick="modStatus('PV', -5)">&lt;&lt;</button>
                    <button class="btn-ctrl" onclick="modStatus('PV', -1)">&lt;</button>
                    <button class="btn-ctrl" onclick="modStatus('PV', 1)">&gt;</button>
                    <button class="btn-ctrl" onclick="modStatus('PV', 5)">&gt;&gt;</button>
                </div>
            </div>

            <div class="bar-wrapper">
                <div class="bar-info">
                    <span>SANIDADE (SAN)</span>
                    <span id="txt-SAN">0 / 0</span>
                </div>
                <div class="progress-bg"><div id="fill-SAN" class="progress-fill" style="width: 100%"></div></div>
                <div class="bar-controls">
                    <button class="btn-ctrl" onclick="modStatus('SAN', -5)">&lt;&lt;</button>
                    <button class="btn-ctrl" onclick="modStatus('SAN', -1)">&lt;</button>
                    <button class="btn-ctrl" onclick="modStatus('SAN', 1)">&gt;</button>
                    <button class="btn-ctrl" onclick="modStatus('SAN', 5)">&gt;&gt;</button>
                </div>
            </div>

            <div class="bar-wrapper">
                <div class="bar-info">
                    <span>PONTOS DE MAGIA (PM)</span>
                    <span id="txt-MAG">0 / 0</span>
                </div>
                <div class="progress-bg"><div id="fill-MAG" class="progress-fill" style="width: 100%"></div></div>
                <div class="bar-controls">
                    <button class="btn-ctrl" onclick="modStatus('MAG', -5)">&lt;&lt;</button>
                    <button class="btn-ctrl" onclick="modStatus('MAG', -1)">&lt;</button>
                    <button class="btn-ctrl" onclick="modStatus('MAG', 1)">&gt;</button>
                    <button class="btn-ctrl" onclick="modStatus('MAG', 5)">&gt;&gt;</button>
                </div>
            </div>
        </div>

        <div class="status-derivados">
            <div class="status-box">SORTE<br><span id="valSORTE" class="result-box">-</span> <button style="padding:2px 5px; font-size: 9px;" onclick="rolarSorte()">üé≤</button></div>
            <div class="status-box">MOV<br><span id="valMOV" class="result-box">-</span></div>
            <div class="status-box">DX<br><span id="valDX" class="result-box">-</span></div>
            <div class="status-box">CORPO<br><span id="valCorpo" class="result-box">-</span></div>
            <div class="status-box">ESQUIVA<br><span id="valESQUIVA" class="result-box">-</span></div>
        </div>
    </div>

    <div class="section">
        <h3>Per√≠cias & Compet√™ncias</h3>
        <div class="grid-pericias" id="periciasContainer"></div>
    </div>

    <div class="section">
        <h3>Arsenal</h3>
        <table class="weapon-table">
            <thead>
                <tr>
                    <th style="width: 25%;">Arma</th>
                    <th>Reg.</th><th>S√≥l.</th><th>Ext.</th><th>Dano</th><th>Alc.</th><th>Atqs</th><th>Mun.</th><th>Def.</th><th></th>
                </tr>
            </thead>
            <tbody id="weaponBody">
                </tbody>
        </table>
        <button onclick="addWeaponRow()" style="margin-top: 15px; font-size: 0.6em;">+ Adicionar Arma</button>
    </div>
</div>

<script>
    // 1. √ÅUDIO & PART√çCULAS
    const m = document.getElementById('bgMusic');
    m.volume = 0.1;
    window.addEventListener('load', () => { m.play().catch(() => {}); });
    
    const bg = document.getElementById('bg-particles');
    for (let i = 0; i < 150; i++) {
        const sq = document.createElement('div');
        sq.className = 'square';
        const size = Math.random() * 15 + 5 + 'px';
        sq.style.width = size; sq.style.height = size;
        sq.style.left = Math.random() * 100 + 'vw';
        sq.style.animationDuration = Math.random() * 10 + 8 + 's';
        sq.style.animationDelay = Math.random() * 15 + 's';
        bg.appendChild(sq);
    }

    // 2. L√ìGICA DE STATUS
    let stats = { PV: { atual: 0, max: 0 }, SAN: { atual: 0, max: 99 }, MAG: { atual: 0, max: 0 } };

    function modStatus(tipo, qtd) {
        stats[tipo].atual = Math.min(stats[tipo].max, Math.max(0, stats[tipo].atual + qtd));
        updateBarVisual(tipo);
    }

    function updateBarVisual(tipo) {
        const percent = stats[tipo].max > 0 ? (stats[tipo].atual / stats[tipo].max) * 100 : 0;
        const fillEl = document.getElementById(`fill-${tipo}`);
        if(fillEl) fillEl.style.width = percent + "%";
        document.getElementById(`txt-${tipo}`).innerText = `${stats[tipo].atual} / ${stats[tipo].max}`;
    }

    // 3. FOTO & ARSENAL
    let historicoFoto = null;
    function carregarFoto(event) {
        const reader = new FileReader();
        const img = document.getElementById('charPhoto');
        reader.onload = () => {
            historicoFoto = img.src;
            document.getElementById('btnDesfazer').disabled = false;
            document.getElementById('btnDesfazer').style.opacity = "1";
            img.src = reader.result; img.style.display = 'block';
            document.getElementById('placeholderTxt').style.display = 'none';
        }
        if(event.target.files[0]) reader.readAsDataURL(event.target.files[0]);
    }

    function removerFoto() {
        const img = document.getElementById('charPhoto');
        if (img.src && img.style.display !== 'none') {
            historicoFoto = img.src;
            document.getElementById('btnDesfazer').disabled = false;
            document.getElementById('btnDesfazer').style.opacity = "1";
            img.src = ""; img.style.display = 'none';
            document.getElementById('placeholderTxt').style.display = 'block';
        }
    }

    function desfazerFoto() {
        if (historicoFoto) {
            const img = document.getElementById('charPhoto');
            const fotoAtual = img.src;
            img.src = historicoFoto; img.style.display = 'block';
            document.getElementById('placeholderTxt').style.display = 'none';
            historicoFoto = fotoAtual; 
        }
    }

    function calcWeapon(input) {
    // Encontra a linha (tr) onde o input est√°
    const row = input.closest('tr');
    // Pega o valor digitado (Regular)
    const val = parseInt(input.value) || 0;
    
    // Seleciona os campos de leitura daquela linha espec√≠fica
    const cells = row.querySelectorAll('.val-auto');
    
    // cells[0] √© o S√≥lido (Metade), cells[1] √© o Extremo (Um quinto)
    cells[0].value = Math.floor(val / 2);
    cells[1].value = Math.floor(val / 5);
}

    function addWeaponRow() {
    const body = document.getElementById('weaponBody');
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td><input type="text" class="weapon-name" placeholder="Ex: .38 Especial"></td>
        <td><input type="number" class="val-reg" oninput="calcWeapon(this)" placeholder="Reg."></td>
        <td><input type="text" class="val-auto" readonly value="0"></td>
        <td><input type="text" class="val-auto" readonly value="0"></td>
        <td><input type="text" placeholder="1D10"></td>
        <td><input type="text" placeholder="15m"></td>
        <td><input type="text" placeholder="1(3)"></td>
        <td><input type="text" placeholder="6"></td>
        <td><input type="text" placeholder="98"></td>
        <td><button class="btn-remove-weapon" onclick="this.closest('tr').remove()">X</button></td>
    `;
    body.appendChild(tr);
}

    // 4. ATRIBUTOS
    const attrTipoA = ["FOR", "CON", "DES", "POD", "APA"]; 
    const attrTipoB = ["TAM", "INT", "EDU"]; 
    const todosAtributos = [...attrTipoA, ...attrTipoB];
    const attrContainer = document.getElementById('attrContainer');
    
    todosAtributos.forEach(attr => {
        attrContainer.innerHTML += `
            <div class="attr-card">
                <label>${attr}</label>
                <input type="number" id="input-${attr}" oninput="atualizarTudo()" min="0">
                <button style="width:100%; margin-top:8px; font-size:9px;" onclick="testarHabilidade('${attr}', document.getElementById('input-${attr}').value)">TESTAR</button>
                <div class="sub-vals">¬Ω: <span id="half-${attr}">0</span> | ‚Öï: <span id="fifth-${attr}">0</span></div>
            </div>
        `;
    });

    // 5. PER√çCIAS
    const listaPericias = [
        { n: "Antropologia", v: 1 }, { n: "Armas de Fogo (Curta)", v: 20 },
        { n: "Armas de Fogo (Rifle)", v: 25 }, { n: "Arremessar", v: 20 },
        { n: "Cavalgar", v: 5 }, { n: "Charlatanismo", v: 5 },
        { n: "Chaveiro", v: 1 }, { n: "Consertos El√©tricos", v: 10 },
        { n: "Consertos Mec√¢nicos", v: 10 }, { n: "Direito", v: 5 },
        { n: "Dirigir Autom√≥vel", v: 20 }, { n: "Disfarce", v: 5 },
        { n: "Escalar", v: 20 }, { n: "Escutar", v: 20 },
        { n: "Esquivar", v: 0 }, { n: "Furtividade", v: 20 },
        { n: "Hist√≥ria", v: 5 }, { n: "Intimida√ß√£o", v: 15 },
        { n: "Lutar (Briga)", v: 25 }, { n: "Medicina", v: 1 },
        { n: "Mundo Natural", v: 10 }, { n: "Nata√ß√£o", v: 20 },
        { n: "Ocultismo", v: 5 }, { n: "Persuas√£o", v: 10 },
        { n: "Primeiros Socorros", v: 30 }, { n: "Psicologia", v: 10 },
        { n: "Rastrear", v: 10 }, { n: "Saltar", v: 20 },
        { n: "Sobreviv√™ncia", v: 10 }, { n: "Usar Bibliotecas", v: 20 }
    ];

    function renderPericias() {
        const container = document.getElementById('periciasContainer');
        const metade = Math.ceil(listaPericias.length / 2);
        for (let i = 0; i < 2; i++) {
            const table = document.createElement('table');
            table.className = "pericias-table";
            table.innerHTML = `<thead><tr><th>Per√≠cia</th><th>Reg.</th><th>S√≥l.</th><th>Ext.</th><th>üé≤</th></tr></thead><tbody id="p-body-${i}"></tbody>`;
            container.appendChild(table);
            const slice = listaPericias.slice(i * metade, (i + 1) * metade);
            const tbody = document.getElementById(`p-body-${i}`);
            slice.forEach(p => {
                const idSafe = p.n.replace(/\s+/g, '-');
                tbody.innerHTML += `<tr><td style="text-align:left; color:#888;">${p.n}</td><td><input type="number" value="${p.v}" id="p-val-${idSafe}" oninput="calcP('${idSafe}')"></td><td><input type="text" class="val-auto" id="p-half-${idSafe}" readonly value="${Math.floor(p.v/2)}"></td><td><input type="text" class="val-auto" id="p-fifth-${idSafe}" readonly value="${Math.floor(p.v/5)}"></td><td><button style="padding:2px 8px; font-size:10px;" onclick="testarHabilidade('${p.n}', document.getElementById('p-val-${idSafe}').value)">üé≤</button></td></tr>`;
            });
        }
    }

    function calcP(id) {
        const val = parseInt(document.getElementById(`p-val-${id}`).value) || 0;
        document.getElementById(`p-half-${id}`).value = Math.floor(val/2);
        document.getElementById(`p-fifth-${id}`).value = Math.floor(val/5);
    }

    // 6. ROLAGEM E SUCESSO
    function testarHabilidade(nome, valorAlvo) {
        const alvo = parseInt(valorAlvo) || 0;
        const roll = Math.floor(Math.random() * 100) + 1;
        const half = Math.floor(alvo / 2); const fifth = Math.floor(alvo / 5);
        const overlay = document.getElementById('result-overlay');
        let title = "FALHA", detail = `${roll} VS ${alvo}`, c="#666", b="#111";
        if (roll === 1) { title="CR√çTICO"; c="#000"; b="#fff"; }
        else if (roll <= fifth) { title="EXTREMO"; c="#fff"; b="#333"; }
        else if (roll <= half) { title="S√ìLIDO"; c="#fff"; b="#666"; }
        else if (roll <= alvo) { title="REGULAR"; c="#000"; b="#999"; }
        else if (roll >= 96 && alvo < 50) { title="DESASTRE"; c="#f00"; b="#300"; }
        else if (roll === 100) { title="DESASTRE"; c="#f00"; b="#300"; }
        document.getElementById('overlay-title').innerText = title;
        document.getElementById('overlay-title').style.color = c;
        document.getElementById('overlay-title').style.backgroundColor = b;
        document.getElementById('overlay-detail').innerText = `${nome.toUpperCase()}: ${detail}`;
        overlay.classList.add('active');
        setTimeout(() => overlay.classList.remove('active'), 2500);
    }

    function rollXDX(qtd, lados) {
        let total = 0; let rolls = [];
        for (let i = 0; i < qtd; i++) {
            let r = Math.floor(Math.random() * lados) + 1;
            rolls.push(r); total += r;
        }
        return { total, formula: rolls.join(' + ') + ' = ' + total };
    }

    function rollCustomDice() {
        const input = document.getElementById('diceInput').value;
        const m = input.match(/(\d+)d(\d+)/i);
        if (m) {
            const res = rollXDX(m[1], m[2]);
            document.getElementById('diceDisplay').innerText = res.formula;
        }
    }

    function atualizarTudo() {
        let v = {};
        todosAtributos.forEach(attr => {
            const el = document.getElementById(`input-${attr}`);
            v[attr] = parseInt(el.value) || 0;
            document.getElementById(`half-${attr}`).innerText = Math.floor(v[attr] / 2);
            document.getElementById(`fifth-${attr}`).innerText = Math.floor(v[attr] / 5);
        });
        const esquivaInput = document.getElementById('p-val-Esquivar');
        if(esquivaInput) {
            const novaEsquiva = Math.floor(v.DES / 2);
            esquivaInput.value = novaEsquiva;
            calcP('Esquivar');
            document.getElementById('valESQUIVA').innerText = novaEsquiva;
        }
        stats.PV.max = Math.floor((v.TAM + v.CON) / 10);
        stats.PV.atual = stats.PV.max;
        stats.SAN.max = 99; stats.SAN.atual = v.POD;
        stats.MAG.max = Math.floor(v.POD / 5); stats.MAG.atual = stats.MAG.max;
        updateBarVisual('PV'); updateBarVisual('SAN'); updateBarVisual('MAG');
        const soma = v.FOR + v.TAM;
        let dx = "0", corpo = "0";
        if (soma <= 124) { dx = "0"; corpo = "0"; }
        else if (soma <= 164) { dx = "+1D4"; corpo = "1"; }
        else { dx = "+1D6"; corpo = "2"; }
        document.getElementById('valDX').innerText = dx;
        document.getElementById('valCorpo').innerText = corpo;
        let mov = 8;
        if (v.DES < v.TAM && v.FOR < v.TAM) mov = 7;
        if (v.FOR > v.TAM && v.DES > v.TAM) mov = 9;
        const idade = parseInt(document.getElementById('idade').value) || 0;
        document.getElementById('valMOV').innerText = Math.max(1, mov - (idade >= 40 ? 1 : 0));
    }

    function gerarTodosAtributos() {
        attrTipoA.forEach(a => document.getElementById(`input-${a}`).value = rollXDX(3, 6).total * 5);
        attrTipoB.forEach(b => document.getElementById(`input-${b}`).value = (rollXDX(2, 6).total + 6) * 5);
        rolarSorte(); atualizarTudo();
    }

    function rolarSorte() {
        const sorte = rollXDX(3, 6).total * 5;
        document.getElementById('valSORTE').innerText = sorte;
    }

    // Inicializa√ß√£o
    renderPericias();
    addWeaponRow(); // Inicia com uma linha de arma
    atualizarTudo();
</script>

</body>
</html>