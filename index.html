<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Call of Cthulhu</title>
    <style>


/* Esta classe s√≥ trava o scroll se o modal estiver aberto */
body.modal-open {
    overflow: hidden !important;
    height: 100vh !important;
}

/* Garante que o container das per√≠cias e arsenal n√£o suma */
#periciasContainer {
    display: flex !important;
    flex-direction: row !important; /* Lado a lado */
    flex-wrap: wrap; /* Permite quebrar linha em telas pequenas */
    gap: 20px;
    justify-content: space-between;
    width: 100%;
}

/* Garante que cada tabela ocupe metade (ou quase metade) da largura */
.pericias-table {
    flex: 1;
    min-width: 300px; /* Largura m√≠nima para n√£o esmagar no celular */
    border-collapse: collapse;
}


.modal-overlay {
    position: fixed !important; /* O !important garante que nada sobressaia */
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    background: rgba(0, 0, 0, 0.95); /* Fundo bem escuro */
    display: none; /* O JS vai mudar para 'flex' */
    z-index: 100000; /* Um valor extremo para ficar na frente de tudo */
    align-items: center;
    justify-content: center;
    margin: 0;
    padding: 0;
}

.modal-box {
    background: #080808;
    border: 2px solid #00ff00;
    width: 85%;
    max-width: 500px;
    max-height: 85vh;
    box-shadow: 0 0 50px rgba(0, 255, 0, 0.3);
    /* Garante que a caixa n√£o herde margens que a empurrem para baixo */
    margin: auto; 
    display: flex !important; /* Garante que a caixa se comporte como flex */
    flex-direction: column;
    min-height: 200px; /* Garante um tamanho m√≠nimo */
}

.modal-header {
    background: #111; padding: 10px; display: flex; justify-content: space-between;
    border-bottom: 1px solid #333; font-family: monospace; color: #00ff00;
}

.ocupacoes-grid {
    display: grid; 
    grid-template-columns: 1fr 1fr; 
    gap: 10px;
    padding: 20px; 
    overflow-y: auto !important; /* Garante que a lista role dentro do modal */
    flex-grow: 1; /* Faz o grid ocupar o espa√ßo dispon√≠vel */
}

.btn-ocupacao-item {
    background: #0a0a0a; border: 1px solid #222; color: #888;
    padding: 10px; text-align: left; cursor: pointer;
    font-size: 11px; transition: 0.2s; text-transform: uppercase;
}

.btn-ocupacao-item:hover {
    border-color: #00ff00; color: #00ff00; background: #001100;
}


/* Container principal precisa ser relativo */
.investigadores-panel {
    position: relative;
    transition: all 0.4s ease-in-out;
    overflow: hidden;
    min-height: 40px; /* Altura m√≠nima da barra quando minimizado */
}

/* Bot√£o de janelinha para o painel de fichas */
.btn-janelinha-fichas {
    position: absolute;
    top: 8px;
    left: 8px;
    background: transparent;
    border: 1px solid #333;
    color: #444;
    font-size: 10px;
    cursor: pointer;
    z-index: 30;
    padding: 2px 5px;
}

.btn-janelinha-fichas:hover {
    color: #00ff00;
    border-color: #00ff00;
}

/* Classe de minimiza√ß√£o do painel */
.panel-minimizado {
    height: 40px !important;
    width: 200px !important; /* Encolhe a largura tamb√©m */
    padding: 0 10px !important;
    opacity: 0.8;
}

.panel-minimizado .panel-content {
    display: none !important;
}


/* Container precisa de posi√ß√£o relativa para o bot√£o se prender a ele */
.music-player-container {
    position: relative;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    overflow: hidden;
}

/* O bot√£o de janelinha */
.btn-janelinha {
    position: absolute;
    top: 5px;
    left: 5px;
    background: transparent;
    border: 1px solid #444;
    color: #666;
    font-size: 10px;
    cursor: pointer;
    z-index: 20;
    padding: 2px 5px;
    transition: 0.2s;
}

.btn-janelinha:hover {
    color: #00ff00;
    border-color: #00ff00;
}

/* Classe de minimiza√ß√£o */
.player-minimizado {
    width: 60px !important;
    height: 30px !important;
    padding: 0 !important;
    border-color: #222 !important;
}

.player-minimizado .player-content {
    display: none; /* Esconde tudo quando minimizado */
}


        /* TELA DE LOGIN E CADASTRO ADICIONADA */
        #login-overlay {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: #000;
    z-index: 20000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start; /* <<< TOPO */
    transition: 1s ease;

    /* MENU DE FICHAS - SLIDE ANIMATION */
.investigadores-panel {
    position: fixed;
    top: 0;
    right: -320px; /* Come√ßa escondido √† direita */
    width: 300px;
    height: 100vh;
    background: rgba(5, 5, 5, 0.98);
    border-left: 2px solid #333;
    padding: 30px 20px;
    z-index: 15000;
    transition: right 0.6s cubic-bezier(0.19, 1, 0.22, 1);
    box-shadow: -10px 0 30px rgba(0,0,0,0.8);
    display: flex;
    flex-direction: column;
}

.modal-overlay {
    /* Troque absolute por fixed */
    position: fixed; 
    top: 0;
    left: 0;
    width: 100vw;   /* Ocupa toda a largura da janela visual */
    height: 100vh;  /* Ocupa toda a altura da janela visual */
    background: rgba(0, 0, 0, 0.9); /* Fundo semi-transparente */
    display: none;
    z-index: 99999; /* Valor bem alto para ficar na frente de TUDO */
    align-items: center;
    justify-content: center;
    overflow: hidden; /* Impede que a p√°gina atr√°s role enquanto o modal est√° aberto */
}

/* Janela centralizada */
.modal-content {
    background: #050505 !important;
    border: 1px solid #00ff00 !important;
    padding: 30px !important;
    width: 450px !important;
    max-width: 90% !important;
    border-radius: 8px !important;
    box-shadow: 0 0 50px rgba(0, 255, 0, 0.2) !important;
    color: #ccc !important;
    pointer-events: auto !important; /* Garante que os cliques funcionem */
}

.modal-header {
    color: #00ff00;
    text-align: center;
    font-weight: bold;
    margin-bottom: 20px;
    border-bottom: 1px solid #222;
    padding-bottom: 10px;
}

.modal-text p {
    font-size: 13px;
    color: #ccc;
    line-height: 1.5;
    margin-bottom: 15px;
}

.btn-close-modal {
    width: 100%;
    padding: 10px;
    background: #111;
    color: #00ff00;
    border: 1px solid #00ff00;
    cursor: pointer;
    margin-top: 10px;
}

/* Estilo do bot√£o "Como usar?" na ficha */
.btn-ajuda-top {
    position: absolute;
    top: 20px;
    right: 20px;
    font-size: 10px;
    background: #003300;
    border: 1px solid #00ff00;
    color: #00ff00;
    padding: 5px 12px;
    cursor: pointer;
    z-index: 100;
    text-transform: uppercase;
    font-weight: bold;
}


.investigadores-panel.active {
    right: 0; /* Desliza para a tela */
}

/* Esconder o container da ficha enquanto o menu estiver aberto */
/* For√ßa a ficha a ficar invis√≠vel e n√£o ocupar espa√ßo */
/* Esconde a ficha e o player de m√∫sica inicialmente */
.main-content, #player-musica { 
    display: none !important; 
}

/* Classe para mostrar os elementos quando necess√°rio */
.visible {
    display: block !important;
}

/* Centraliza o Menu de Arquivos no meio da tela ap√≥s o login */
.investigadores-panel {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.9); /* Centralizado e levemente menor */
    width: 350px;
    background: #050505;
    border: 1px solid #222;
    padding: 30px;
    z-index: 10000;
    opacity: 0;
    visibility: hidden;
    transition: all 0.5s ease;
}

/* Quando o menu estiver ativo, ele aparece suavemente */
.investigadores-panel.active {
    opacity: 1;
    visibility: visible;
    transform: translate(-50%, -50%) scale(1);
}

.empty-msg {
    color: #444;
    text-align: center;
    font-style: italic;
    margin-top: 50px;
    font-size: 0.8em;
}

.menu-footer {
    margin-top: auto;
    padding-top: 20px;
    border-top: 1px solid #222;
}

.investigador-item {
    display: flex;
    flex-direction: column;
    gap: 8px;
    border-bottom: 1px solid #1a1a1a;
    padding: 15px 0;
}

.inv-actions {
    display: flex;
    gap: 5px;
}

.btn-rename { background: #222200; color: #ffff00; font-size: 9px; }
}

        .login-card {
            background: #0d0d0d;
            padding: 40px;
            border: 1px solid #222;
            text-align: center;
            box-shadow: 0 0 50px rgba(0,0,0,1);
            max-width: 400px;
            width: 90%;
            
        }

        .login-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            background: transparent;
            border: none;
            color: #444;
            cursor: pointer;
            font-size: 0.7em;
            letter-spacing: 2px;
        }

        .tab-btn.active {
            color: #fff;
            border-bottom: 2px solid #fff;
        }

        .input-group {
            margin-bottom: 15px;
            text-align: left;
        }

        /* ANIMA√á√ïES DE ENTRADA */
        @keyframes fadeInTotal {
            from { opacity: 0; filter: blur(10px); }
            to { opacity: 1; filter: blur(0); }
        }

        @keyframes subirEntrada {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .val-auto {
            background: rgba(255, 255, 255, 0.05) !important;
            color: #777 !important;
            font-style: italic;
            cursor: not-allowed;
        }

        /* EST√âTICA NOIR EXUBERANTE */
        body { 
            font-family: 'Garamond', serif; 
            background-color: #050505; 
            background-image: radial-gradient(circle at center, #1a1a1a 0%, #050505 100%);
            color: #f2f2f2; 
            padding: 20px; 
            line-height: 1.6; 
            overflow-x: hidden;
            opacity: 0;
            animation: fadeInTotal 2s ease-out forwards;
        }

        /* FUNDO DE QUADRADOS SUBINDO */
        #bg-particles {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        .square {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            bottom: -50px;
            animation: sobeQuadradinho 12s linear infinite;
        }

        @keyframes sobeQuadradinho {
            0% { transform: translateY(0) rotate(0deg); opacity: 0; }
            10% { opacity: 0.2; }
            90% { opacity: 0.2; }
            100% { transform: translateY(-120vh) rotate(720deg); opacity: 0; }
        }

        /* PLAYER E GIF */
        .music-player-container {
            position: fixed;
            top: 20px; 
            left: 20px; 
            z-index: 1000;
            background: rgba(0,0,0,0.95);
            padding: 30px; 
            border: 2px solid #333; 
            text-align: center;
            box-shadow: 0 0 40px rgba(0,0,0,1);
            animation: subirEntrada 1.5s ease-out 0.8s forwards;
            opacity: 0;
            width: 260px;
        }

        .gif-musica {
            width: 220px; 
            margin-bottom: 20px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            filter: grayscale(100%) contrast(1.2);
            border: 1px solid #222;
        }

        /* CONTAINER DA FICHA */
        .container { 
            
            max-width: 950px; 
            margin: 40px auto; 
            background: #0d0d0d; 
            padding: 40px; 
            border: 1px solid #2a2a2a; 
            box-shadow: 0 0 60px rgba(0,0,0,1), inset 0 0 20px rgba(255,255,255,0.02);
            position: relative;
            z-index: 1;
        }

        

        .container::before {
            content: "";
            position: absolute;
            top: 10px; left: 10px; right: 10px; bottom: 10px;
            border: 1px solid #1a1a1a;
            pointer-events: none;
        }

        .logo-projeto { 
            display: block; 
            margin: 0 auto 30px; 
            width: 160px; 
            height: 160px; 
            object-fit: cover; 
            border-radius: 50%; 
            filter: brightness(1.1) contrast(1.1);
            border: 3px solid #222;
            padding: 5px; 
            background: linear-gradient(145deg, #111, #000);
            box-shadow: 0 0 20px rgba(0,0,0,0.8), inset 0 0 10px rgba(255,255,255,0.05);
        }

        h1, h2, h3 { 
            text-align: center; 
            color: #ffffff; 
            text-transform: uppercase; 
            letter-spacing: 5px; 
            font-weight: 300;
            margin-bottom: 25px;
            border-bottom: 1px solid #333;
            display: block;
            padding-bottom: 10px;
        }

        .section { 
            margin-bottom: 35px; 
            padding: 25px; 
            border: 1px solid #222; 
            background: rgba(20, 20, 20, 0.8);
            box-shadow: 5px 5px 15px rgba(0,0,0,0.5);
        }

        .header-ficha { display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-start; }
        
        .foto-wrapper {
            position: sticky;
            top: 20px;
            z-index: 10;
        }

        .foto-container { 
            width: 200px; height: 250px; background: #000; border: 1px solid #333; 
            position: relative; cursor: pointer; overflow: hidden; display: flex; 
            align-items: center; justify-content: center; transition: 0.5s;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        .foto-container:hover { border-color: #fff; }
        .foto-container img { width: 100%; height: 100%; object-fit: cover; }
        .foto-placeholder { text-align: center; color: #444; font-size: 0.7em; letter-spacing: 2px; }

        .info-pessoais { flex: 1; display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; }
        .field { display: flex; flex-direction: column; }
        label { font-size: 0.7em; margin-bottom: 6px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        
        input { 
            background: #000; color: #913a3a; border: 1px solid #222; 
            padding: 10px; border-radius: 0; font-family: 'Courier New', monospace;
            transition: 0.3s;
        }
        input:focus { border-color: #555; outline: none; background: #050505; }

        button { 
            cursor: pointer; background: linear-gradient(180deg, #333 0%, #111 100%); 
            color: #bbb; border: 1px solid #444; padding: 12px 18px; 
            text-transform: uppercase; font-size: 0.7em; letter-spacing: 2px; transition: 0.3s; 
        }
        button:hover { background: #fff; color: #000; border-color: #fff; box-shadow: 0 0 15px rgba(255,255,255,0.2); }

        .weapon-table, .pericias-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.8em; }
        .weapon-table th, .pericias-table th { background: #151515; color: #888; text-transform: uppercase; padding: 10px; border: 1px solid #222; font-weight: normal; letter-spacing: 1px; }
        .weapon-table td, .pericias-table td { border: 1px solid #222; padding: 5px; background: #0a0a0a; }
        .weapon-table input, .pericias-table input { width: 90%; border: none; background: transparent; padding: 5px; color: #eee; text-align: center; }

        .btn-remove-weapon { background: #300; color: #fff; border: none; padding: 2px 8px; cursor: pointer; transition: 0.3s; }
        .btn-remove-weapon:hover { background: #f00; }

        .grid-pericias { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }

        .dice-roller { background: #0a0a0a; border: 1px solid #222; padding: 25px; margin-bottom: 30px; text-align: center; }
        .dice-display { margin-top: 15px; font-family: 'Courier New', monospace; font-size: 1.3em; color: #fff; background: #000; padding: 15px; border: 1px solid #1a1a1a; }

        .grid-atributos { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        .attr-card { background: #0f0f0f; padding: 20px; border: 1px solid #222; text-align: center; position: relative; }
        .sub-vals { font-size: 0.7em; color: #555; margin-top: 12px; border-top: 1px solid #1a1a1a; padding-top: 8px; }
        
        .status-container-complex { display: flex; flex-direction: column; gap: 20px; margin-bottom: 30px; }
        .bar-wrapper { background: #050505; border: 1px solid #222; padding: 15px; position: relative; }
        .bar-info { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.8em; letter-spacing: 1px; }
        .progress-bg { background: #111; height: 12px; border: 1px solid #000; width: 100%; position: relative; }
        .progress-fill { height: 100%; transition: width 0.4s ease; }
        
        #fill-PV { background: linear-gradient(90deg, #600, #f00); box-shadow: 0 0 10px rgba(255,0,0,0.3); }
        #fill-SAN { background: linear-gradient(90deg, #004, #06f); box-shadow: 0 0 10px rgba(0,100,255,0.3); }
        #fill-MAG { background: linear-gradient(90deg, #303, #a0a); box-shadow: 0 0 10px rgba(160,0,160,0.3); }

        .bar-controls { display: flex; align-items: center; gap: 5px; margin-top: 10px; justify-content: center; }
        .btn-ctrl { padding: 2px 8px; font-size: 10px; min-width: 35px; }

        .status-derivados { display: flex; flex-wrap: wrap; gap: 12px; justify-content: center; margin-top: 20px; }
        .status-box { background: linear-gradient(145deg, #111, #050505); padding: 15px; border: 1px solid #2a2a2a; min-width: 110px; text-align: center; }
        .result-box { color: #fff; font-size: 1.5em; font-weight: 300; display: block; margin-top: 5px; }

        #result-overlay {
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%) scale(0);
            z-index: 10000; 
            text-align: center; 
            pointer-events: none;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: 100%;
        }
        #result-overlay.active { transform: translate(-50%, -50%) scale(1.8); }
        .res-title { font-size: 3rem; background: #fff; color: #000; padding: 5px 30px; border: 4px double #000; display: inline-block; }
        .res-detail { font-size: 1rem; color: #fff; background: #000; padding: 5px 15px; border: 1px solid #fff; margin-top: 10px; display: block; margin-left: auto; margin-right: auto; max-width: fit-content; }

        footer {
            margin-top: 50px;
            text-align: center;
            padding: 20px;
            border-top: 1px solid #222;
            font-family: 'Courier New', monospace;
            font-size: 0.8em;
            color: #444;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        footer b { color: #666; font-weight: normal; }

        .save-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 5000;
        }

        .investigadores-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 280px;
            max-height: 80vh;
            background: rgba(0,0,0,0.95);
            border: 2px solid #333;
            padding: 20px;
            z-index: 1000;
            overflow-y: auto;
            box-shadow: 0 0 40px rgba(0,0,0,1);
        }

        .investigador-item {
            background: #0a0a0a;
            border: 1px solid #222;
            padding: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .investigador-item:hover {
            border-color: #fff;
            background: #111;
        }

        .investigador-item button {
            padding: 5px 10px;
            font-size: 9px;
            background: #300;
        }

        .btn-add-pericia {
            background: #003300;
            border-color: #006600;
            color: #00ff00;
            margin-top: 10px;
            font-size: 0.6em;
            padding: 8px 15px;
        }

        .pericia-custom {
            background: #0a0a0a !important;
        }

        .pericia-custom td:first-child {
            color: #00ff00 !important;
        }

/* --- ESTILOS DOS REQUISITOS DE SENHA --- */

.req-container {
    margin-top: 10px;
    text-align: left;
    font-size: 10px;
    padding: 10px;
    background: #050505;
    border: 1px solid #222;
    border-radius: 4px;
    font-family: monospace;
}

.req-item {
    color: #550000; /* Vermelho escuro/apagado para o estado inicial */
    transition: all 0.3s ease;
    margin-bottom: 5px;
    display: flex;
    align-items: center;
}

/* Bolinha indicadora antes do texto */
.req-item::before {
    content: "‚úñ";
    margin-right: 8px;
    font-size: 8px;
}

/* Quando o requisito for cumprido */
.req-item.valid {
    color: #00ff00; /* Verde brilhante */
    text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
    transform: translateX(5px); /* Pequeno deslocamento para a direita */
}

.req-item.valid::before {
    content: "‚úî";
}

    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-card">
        <img src="https://i.pinimg.com/736x/71/8a/d9/718ad93c88c10dea945392bfa43ed220.jpg" style="width: 80px; border-radius: 50%; margin-bottom: 20px; filter: grayscale(1);">
        
        <div class="login-tabs">
            <button class="tab-btn active" id="btn-login-tab" onclick="switchTab('login')">ENTRAR</button>
            <button class="tab-btn" id="btn-signup-tab" onclick="switchTab('signup')">CRIAR CONTA</button>
            <button class="tab-btn" id="btn-sync-tab" onclick="switchTab('sync')">SINCRONIZAR</button>
        </div>

        <div id="login-form">
            <div class="input-group">
                <label>NOME DE INVESTIGADOR</label>
                <input type="text" id="loginUser" style="width: 100%;">
            </div>
            <div class="input-group">
                <label>SENHA DE ACESSO</label>
                <input type="password" id="loginPass" style="width: 100%;">
            </div>
            <button onclick="realizarLogin()" style="width: 100%; margin-top: 10px;">ABRIR ARQUIVO</button>
        </div>

        <div id="signup-form" style="display: none;">
            <div class="input-group">
                <label>NOVO NOME DE INVESTIGADOR</label>
                <input type="text" id="signupUser" style="width: 100%;">
            </div>
            <div class="input-group">
                <label>CRIAR SENHA</label>
                <input type="password" id="signupPass" style="width: 100%;">
                
                <div id="password-requirements" class="req-container">
                    <div id="req-length" class="req-item">M√≠nimo 6 caracteres</div>
                    <div id="req-upper" class="req-item">1 Letra mai√∫scula</div>
                    <div id="req-lower" class="req-item">1 Letra min√∫scula</div>
                    <div id="req-number" class="req-item">1 N√∫mero</div>
                    <div id="req-special" class="req-item">1 Caractere especial</div>
                </div>
            </div>
            <button onclick="realizarCadastro()" style="width: 100%; margin-top: 10px;">REGISTRAR INVESTIGADOR</button>
        </div>

        <div id="sync-form" style="display: none; padding: 10px;">
            <p style="font-size: 11px; color: #888; margin-bottom: 15px;">Cole o c√≥digo gerado no seu PC para importar o investigador:</p>
            <div class="input-group">
                <label>C√ìDIGO COC-</label>
                <input type="text" id="syncCodeInput" placeholder="Cole aqui...">
            </div>
            <button onclick="importarConta()" style="width: 100%;">IMPORTAR INVESTIGADOR</button>
            <p style="font-size: 9px; color: #555; margin-top: 15px;">*Isso salvar√° a conta neste navegador.</p>
        </div>
        
        <p id="login-msg" style="font-size: 10px; color: #913a3a; margin-top: 15px;"></p>
    </div>
</div>

            </div>
            <button onclick="realizarCadastro()" style="width: 100%; margin-top: 10px;">REGISTRAR INVESTIGADOR</button>
        </div>
        
        <p id="login-msg" style="font-size: 10px; color: #913a3a; margin-top: 15px;"></p>
    </div>
</div>

<div id="bg-particles"></div>

<div id="menu-fichas" class="investigadores-panel">
    <button class="btn-janelinha-fichas" onclick="minimizarFichas()">üóó</button>

    <div class="panel-content" id="fichasContent">
        <div style="text-align: center; margin-bottom: 30px;">
            <img src="https://i.pinimg.com/736x/71/8a/d9/718ad93c88c10dea945392bfa43ed220.jpg" style="width: 60px; border-radius: 50%; filter: grayscale(1); margin-bottom: 10px; border: 1px solid #333;">
            <h3 style="font-size: 1em; letter-spacing: 4px; border: none; margin: 0;">ARQUIVOS CONFIDENCIAIS</h3>
            <p style="font-size: 9px; color: #555; letter-spacing: 2px;">SELECIONE UM INVESTIGADOR ATIVO</p>
        </div>

        <div id="investigadores-list" style="flex-grow: 1; overflow-y: auto; padding-right: 5px;">
        </div>

        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #222;">
            <button onclick="criarNovoInvestigador()" style="width: 100%; margin-bottom: 12px; background: #0f0f0f; color: #666; font-weight: bold;">
                + REGISTRAR NOVO INVESTIGADOR
            </button>
            <button onclick="location.reload()" style="width: 100%; font-size: 9px; background: #1a1a1a; color: #666;">
                DESCONECTAR INVESTIGADOR
            </button>
        </div>
    </div>
</div>

<div class="save-controls">
    <button onclick="salvarLocal()" style="background: #002200; border-color: #004400; color: #00ff00;">SALVAR INVESTIGADOR</button>
    <button onclick="resetarFicha()" style="background: #332200; border-color: #664400; color: #ffaa00;">RESETAR FICHA</button>
    <button onclick="fazerLogout()" style="background: #330000; border-color: #550000; color: #ff0000;">LOGOUT</button>
    <button onclick="gerarCodigoDeConta()" style="background: #004400; color: #00ff00; border: 1px solid #00ff00;">GERAR C√ìDIGO</button>
</div>

<div class="music-player-container" id="playerMusica">
    <button class="btn-janelinha" onclick="minimizarPlayer()">üóó</button>

    <div class="player-content">
        <img src="https://c.tenor.com/2qFbEpeTPkMAAAAC/tenor.gif" class="gif-musica" alt="Musica">
        <div style="font-size: 0.9em; color: #fff; margin-bottom: 15px; font-family: monospace; letter-spacing: 1px;">HIP SHOP</div>
        
        <audio id="bgMusic" loop>
            <source src="DELTARUNE OST   Rouxls Kaard Shop Hip Shop EXTENDED - Franti≈°ek D (youtube).mp3">
        </audio>

        <div class="bar-controls">
            <button class="btn-ctrl" style="padding: 12px 25px; font-size: 14px;" onclick="document.getElementById('bgMusic').play()">‚ñ∂ PLAY</button>
            <button class="btn-ctrl" style="padding: 12px 25px; font-size: 14px;" onclick="document.getElementById('bgMusic').pause()">‚Ö° PAUSE</button>
        </div>
        
        <div style="margin-top: 20px; padding: 0 10px;">
            <input type="range" id="volSlider" min="0" max="1" step="0.01" value="0.1" oninput="document.getElementById('bgMusic').volume = this.value" style="width: 100%; cursor: pointer; filter: grayscale(1);">
            <label style="font-size: 10px; color: #666; display: block; margin-top: 5px;">VOLUME MASTER</label>
        </div>
    </div>
</div>

<div id="result-overlay">
    <p id="overlay-title" class="res-title"></p>
    <p id="overlay-detail" class="res-detail"></p>
</div>

<div class="container main-content" id="ficha-editor">

<div id="player-musica" class="main-content">
    
   <button onclick="abrirAjuda()" class="btn-ajuda-top">
    COMO USAR?
</button></p>

<body>
    <div id="ajuda-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="color:#5c2020; text-align:left; margin-top:0;">MANUAL DE OPERA√á√ïES</h3>
            <div class="modal-text">
                <p>1. <b>Registro:</b> Clique em "Registrar Novo Investigador" no menu principal.</p>
                <p>2. <b>Dados:</b> Preencha as informa√ß√µes e atributos do investigador.</p>
                <p>3. <b>Salvamento:</b> Role at√© o fim e clique em "Salvar Investigador".</p>
                <p>4. <b>M√∫ltiplos:</b> O sistema salva seu investigador atual antes de criar um novo.</p>
            </div>
            <button class="btn-close-modal" onclick="fecharAjuda()">ENTENDIDO</button>
        </div>
    </div>

    





    <img src="https://i.pinimg.com/736x/71/8a/d9/718ad93c88c10dea945392bfa43ed220.jpg" alt="Logo CoC" class="logo-projeto">
    <h1>Investigador Call of Cthulhu</h1>
    

    <div class="section">
        <div class="header-ficha">
            <div class="foto-wrapper">
                <div class="field" style="align-items: center;">
                    <div class="foto-container" onclick="document.getElementById('fileInput').click()">
                        <div class="foto-placeholder" id="placeholderTxt">REGISTRO VISUAL<br>CLIQUE PARA INSERIR</div>
                        <img id="charPhoto" src="" style="display:none;">
                        <input type="file" id="fileInput" hidden accept="image/*" onchange="carregarFoto(event)">
                    </div>
                    <div style="margin-top: 10px; display: flex; gap: 10px;">
                        <button onclick="removerFoto()" style="padding: 5px 10px; font-size: 9px; background: #300;">REMOVER</button>
                        <button id="btnDesfazer" onclick="desfazerFoto()" style="padding: 5px 10px; font-size: 9px; opacity: 0.5;" disabled>‚Ü© VOLTAR</button>
                    </div>
                </div>
            </div>

            <div class="info-pessoais" id="camposPessoais">
                <div class="field"><label>Nome</label><input type="text" data-key="nome"></div>
                <div class="field"><label>Jogador(a)</label><input type="text" data-key="jogador"></div>

               <div class="field">
    <label>Ocupa√ß√£o</label>


<div class="bloco-ocupacao" style="margin-bottom: 20px;">
    <label style="color: #666; font-size: 11px; display: block; margin-bottom: 5px;">OCUPA√á√ÉO ATUAL</label>
    
    <div style="display: flex; gap: 10px; align-items: center;">
        <input type="text" id="input-ocupacao" readonly placeholder="Selecione uma ocupa√ß√£o..." 
               style="background: #0a0a0a; border: 1px solid #333; color: #00ff00; padding: 10px; flex-grow: 1; font-family: monospace;">
        
        <button type="button" onclick="abrirModalOcupacoes()" 
                style="background: #111; border: 1px solid #00ff00; color: #00ff00; padding: 10px; cursor: pointer;">
            ALTERAR
        </button>
    </div>

    <div style="margin-top: 10px; background: #050505; border: 1px dashed #333; padding: 10px; text-align: center;">
        <span style="color: #666; font-size: 10px;">PONTOS DE PER√çCIA OCUPACIONAIS:</span>
        <div id="display-pontos-ocupacao" style="color: #00ff00; font-size: 24px; font-weight: bold; font-family: 'Courier New';">0</div>
        <small id="formula-usada" style="color: #444; font-size: 9px;"></small>
    </div>
</div>


</div>

<div id="modal-ocupacoes" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <span>SELECIONAR OCUPA√á√ÉO</span>
            <button onclick="fecharModalOcupacoes()">X</button>
        </div>
        <div id="lista-ocupacoes-grid" class="ocupacoes-grid">
            </div>
    </div>
</div>

                <div class="field"><label>Idade</label><input type="number" id="idade" oninput="atualizarTudo()" value="25" data-key="idade"></div>
                <div class="field"><label>G√™nero</label><input type="text" data-key="genero"></div>
                <div class="field"><label>Resid√™ncia</label><input type="text" data-key="residencia"></div>
                <div class="field"><label>Local de Nasc.</label><input type="text" data-key="nasc"></div>
            </div>
        </div>
    </div>

    <div class="dice-roller">
        <label style="color: #666; letter-spacing: 2px;">MECANISMO DE PROBABILIDADE</label><br><br>
        <input type="text" id="diceInput" placeholder="Ex: 3d6">
        <button onclick="rollCustomDice()">EXECUTAR ROLAGEM</button>
        <div id="diceDisplay" class="dice-display">AGUARDANDO...</div>
    </div>

    <div class="section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin:0; border:none;">Atributos Base</h2>
            <button onclick="gerarTodosAtributos()" style="font-size: 0.6em; padding: 5px 10px;">AUTO-GERAR</button>
        </div>
        <div id="attrContainer" class="grid-atributos"></div>
    </div>

    <div class="section">
    <h3>Sinais Vitais e Ps√≠quicos</h3>
    <div class="status-container-complex">
        <div class="bar-wrapper">
            <div class="bar-info">
                <span>PONTOS DE VIDA (PV)</span>
                <span id="txt-PV">0 / 0</span>
            </div>
            <div class="progress-bg"><div id="fill-PV" class="progress-fill" style="width: 100%"></div></div>
            <div style="display: flex; gap: 10px; margin-top: 10px; align-items: center; justify-content: center;">
                <div style="border: 1px solid #333; padding: 8px; background: #0a0a0a;">
                    <label style="font-size: 9px; margin-bottom: 5px; display: block;">ATUAL</label>
                    <div class="bar-controls">
                        <button class="btn-ctrl" onclick="modStatus('PV', -5)">&lt;&lt;</button>
                        <button class="btn-ctrl" onclick="modStatus('PV', -1)">&lt;</button>
                        <button class="btn-ctrl" onclick="modStatus('PV', 1)">&gt;</button>
                        <button class="btn-ctrl" onclick="modStatus('PV', 5)">&gt;&gt;</button>
                    </div>
                </div>
                <div style="border: 1px solid #333; padding: 8px; background: #0a0a0a;">
                    <label style="font-size: 9px; margin-bottom: 5px; display: block;">M√ÅXIMO</label>
                    <div class="bar-controls">
                        <button class="btn-ctrl" onclick="modStatusMax('PV', -5)">&lt;&lt;</button>
                        <button class="btn-ctrl" onclick="modStatusMax('PV', -1)">&lt;</button>
                        <button class="btn-ctrl" onclick="modStatusMax('PV', 1)">&gt;</button>
                        <button class="btn-ctrl" onclick="modStatusMax('PV', 5)">&gt;&gt;</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="bar-wrapper">
            <div class="bar-info">
                <span>SANIDADE (SAN)</span>
                <span id="txt-SAN">0 / 0</span>
            </div>
            <div class="progress-bg"><div id="fill-SAN" class="progress-fill" style="width: 100%"></div></div>
            <div style="display: flex; gap: 10px; margin-top: 10px; align-items: center; justify-content: center;">
                <div style="border: 1px solid #333; padding: 8px; background: #0a0a0a;">
                    <label style="font-size: 9px; margin-bottom: 5px; display: block;">ATUAL</label>
                    <div class="bar-controls">
                        <button class="btn-ctrl" onclick="modStatus('SAN', -5)">&lt;&lt;</button>
                        <button class="btn-ctrl" onclick="modStatus('SAN', -1)">&lt;</button>
                        <button class="btn-ctrl" onclick="modStatus('SAN', 1)">&gt;</button>
                        <button class="btn-ctrl" onclick="modStatus('SAN', 5)">&gt;&gt;</button>
                    </div>
                </div>
                <div style="border: 1px solid #333; padding: 8px; background: #0a0a0a;">
                    <label style="font-size: 9px; margin-bottom: 5px; display: block;">M√ÅXIMO</label>
                    <div class="bar-controls">
                        <button class="btn-ctrl" onclick="modStatusMax('SAN', -5)">&lt;&lt;</button>
                        <button class="btn-ctrl" onclick="modStatusMax('SAN', -1)">&lt;</button>
                        <button class="btn-ctrl" onclick="modStatusMax('SAN', 1)">&gt;</button>
                        <button class="btn-ctrl" onclick="modStatusMax('SAN', 5)">&gt;&gt;</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="bar-wrapper">
            <div class="bar-info">
                <span>PONTOS DE MAGIA (PM)</span>
                <span id="txt-MAG">0 / 0</span>
            </div>
            <div class="progress-bg"><div id="fill-MAG" class="progress-fill" style="width: 100%"></div></div>
            <div style="display: flex; gap: 10px; margin-top: 10px; align-items: center; justify-content: center;">
                <div style="border: 1px solid #333; padding: 8px; background: #0a0a0a;">
                    <label style="font-size: 9px; margin-bottom: 5px; display: block;">ATUAL</label>
                    <div class="bar-controls">
                        <button class="btn-ctrl" onclick="modStatus('MAG', -5)">&lt;&lt;</button>
                        <button class="btn-ctrl" onclick="modStatus('MAG', -1)">&lt;</button>
                        <button class="btn-ctrl" onclick="modStatus('MAG', 1)">&gt;</button>
                        <button class="btn-ctrl" onclick="modStatus('MAG', 5)">&gt;&gt;</button>
                    </div>
                </div>
                <div style="border: 1px solid #333; padding: 8px; background: #0a0a0a;">
                    <label style="font-size: 9px; margin-bottom: 5px; display: block;">M√ÅXIMO</label>
                    <div class="bar-controls">
                        <button class="btn-ctrl" onclick="modStatusMax('MAG', -5)">&lt;&lt;</button>
                        <button class="btn-ctrl" onclick="modStatusMax('MAG', -1)">&lt;</button>
                        <button class="btn-ctrl" onclick="modStatusMax('MAG', 1)">&gt;</button>
                        <button class="btn-ctrl" onclick="modStatusMax('MAG', 5)">&gt;&gt;</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="status-derivados">
        <div class="status-box">SORTE<br><span id="valSORTE" class="result-box">-</span> <button style="padding:2px 5px; font-size: 9px;" onclick="rolarSorte()">üé≤</button></div>
        <div class="status-box">MOV<br><span id="valMOV" class="result-box">-</span></div>
        <div class="status-box">DX<br><span id="valDX" class="result-box">-</span></div>
        <div class="status-box">CORPO<br><span id="valCorpo" class="result-box">-</span></div>
        <div class="status-box">ESQUIVA<br><span id="valESQUIVA" class="result-box">-</span></div>
    </div>
</div>

    <div class="section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin:0; border:none;">Per√≠cias & Compet√™ncias</h3>
            <button onclick="adicionarPericiaCustom()" class="btn-add-pericia">+ ADICIONAR PER√çCIA</button>
        </div>
        <div class="grid-pericias" id="periciasContainer"></div>
    </div>


    <small id="formula-usada" style="font-size: 9px; color: #444; text-transform: uppercase;"></small>
</div>

    <div class="section">
        <h3>Arsenal</h3>
        <table class="weapon-table">
            <thead>
                <tr>
                    <th style="width: 25%;">Arma</th>
                    <th>Reg.</th><th>S√≥l.</th><th>Ext.</th><th>Dano</th><th>Alc.</th><th>Atqs</th><th>Mun.</th><th>Def.</th><th></th>
                </tr>
            </thead>
            <tbody id="weaponBody"></tbody>
        </table>
        <button onclick="addWeaponRow()" style="margin-top: 15px; font-size: 0.6em;">+ Adicionar Arma</button>
    </div>

    <footer>
        Direitos reservados: <b>Anderson - Volkomenn</b> ‚Äî ¬© 2026
    </footer>
</div>

<script>
    // --- L√ìGICA DE LOGIN, SENHA E CONTAS (ADICIONADA) ---
    let agenteLogado = null;
    let investigadorAtual = null;

    function switchTab(tab) {
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const loginBtn = document.getElementById('btn-login-tab');
        const signupBtn = document.getElementById('btn-signup-tab');
        document.getElementById('login-msg').innerText = "";

        if(tab === 'login') {
            loginForm.style.display = 'block';
            signupForm.style.display = 'none';
            loginBtn.classList.add('active');
            signupBtn.classList.remove('active');
        } else {
            loginForm.style.display = 'none';
            signupForm.style.display = 'block';
            loginBtn.classList.remove('active');
            signupBtn.classList.add('active');
        }
    }

function abrirAjuda() {
    console.log("Abrindo ajuda..."); // Teste no console (F12)
    const modal = document.getElementById('ajuda-modal');
    if(modal) {
        modal.style.setProperty('display', 'flex', 'important');
    }
}

function fecharAjuda() {
    const modal = document.getElementById('ajuda-modal');
    if(modal) {
        modal.style.setProperty('display', 'none', 'important');
    }
}

    function realizarCadastro() {
        const user = document.getElementById('signupUser').value.trim();
        const pass = document.getElementById('signupPass').value.trim();
        const msg = document.getElementById('login-msg');

       // Valida√ß√£o de senha forte
const senhaForte =
    pass.length >= 6 &&               // +5 caracteres
    /[A-Z]/.test(pass) &&             // 1 letra mai√∫scula
    /[a-z]/.test(pass) &&             // 1 letra min√∫scula
    /[\W_]/.test(pass) &&             // 1 caractere especial
    /\d/.test(pass);                  // 1 n√∫mero

if(!senhaForte) {
    msg.innerText =
        "A SENHA DEVE TER:\n" +
        "- 1 LETRA MAI√öSCULA\n" +
        "- 1 LETRA MIN√öSCULA\n" +
        "- 1 N√öMERO\n" +
        "- 1 CARACTERE ESPECIAL\n" +
        "- M√çNIMO 6 CARACTERES";
    return;

    
}



if(localStorage.getItem("CoC_User_" + user)) return msg.innerText = "ESTE INVESTIGADOR J√Å EST√Å REGISTRADO";
    const userData = { password: pass, investigadores: [] };
    localStorage.setItem("CoC_User_" + user, JSON.stringify(userData));
    msg.style.color = "#00ff00";
    msg.innerText = "INVESTIGADOR REGISTRADO! AGORA FA√áA LOGIN.";
    setTimeout(() => switchTab('login'), 1500);
}

function realizarLogin() {
    const user = document.getElementById('loginUser').value.trim();
    const pass = document.getElementById('loginPass').value.trim();
    const msg = document.getElementById('login-msg');

    const savedData = localStorage.getItem("CoC_User_" + user);
    if(!savedData) return msg.innerText = "AGENTE N√ÉO ENCONTRADO";
    
    const userData = JSON.parse(savedData);
    if(userData.password !== pass) return msg.innerText = "SENHA INCORRETA";

    // --- AQUI EST√Å A MUDAN√áA ---
    agenteLogado = user;
    localStorage.setItem("Agente_Sessao_Ativa", user); // Salva o login no dispositivo
    
    // Procedimento normal de abrir o painel
    document.getElementById('login-overlay').style.display = "none";
    document.querySelectorAll('.main-content').forEach(el => el.classList.remove('visible'));
    document.getElementById('menu-fichas').classList.add('active'); 
    
    atualizarListaInvestigadores();
}

function abrirFicha(id) {
    const savedData = JSON.parse(localStorage.getItem("CoC_User_" + agenteLogado));
    const inv = savedData.investigadores.find(i => i.id === id);
    
    if(inv) {
        investigadorAtual = id;
        limparFicha(); 
        if(inv.ficha) aplicarDados(inv.ficha);
        
        // 1. Esconde o Menu de Sele√ß√£o
        document.getElementById('menu-fichas').classList.remove('active');
        
        // 2. Mostra a ficha e o player de m√∫sica
        document.querySelectorAll('.main-content').forEach(el => el.classList.add('visible'));
    }
}

function voltarAoMenu() {
    // Esconde a ficha/player e volta para o menu central
    document.querySelectorAll('.main-content').forEach(el => el.classList.remove('visible'));
    document.getElementById('menu-fichas').classList.add('active');
    atualizarListaInvestigadores();
}

function criarNovoInvestigador() {
    const nome = prompt("Nome do novo investigador:");
    if(!nome || !nome.trim()) return;

    const savedData = JSON.parse(localStorage.getItem("CoC_User_" + agenteLogado));
    const novoId = Date.now();
    
    const novoInv = {
        id: novoId,
        nome: nome.trim(),
        ficha: null 
    };
    
    savedData.investigadores.push(novoInv);
    localStorage.setItem("CoC_User_" + agenteLogado, JSON.stringify(savedData));
    
    // J√° abre direto para edi√ß√£o
    abrirFicha(novoId);
}

function atualizarListaInvestigadores() {
    if(!agenteLogado) return;
    const savedData = JSON.parse(localStorage.getItem("CoC_User_" + agenteLogado));
    const lista = document.getElementById('investigadores-list');
    lista.innerHTML = "";

    // Mensagem caso n√£o existam fichas
    if(!savedData.investigadores || savedData.investigadores.length === 0) {
        lista.innerHTML = `
            <div style="text-align:center; padding:40px 10px; color:#444; border:1px dashed #222; border-radius:8px;">
                <p style="font-size:11px; text-transform:uppercase;">Nenhum registro encontrado no banco de dados.</p>
            </div>`;
        return;
    }

    savedData.investigadores.forEach(inv => {
        const div = document.createElement('div');
        div.style.cssText = "background:#111; border:1px solid #222; padding:12px; margin-bottom:10px; border-radius:4px;";
        div.innerHTML = `
            <div style="color:#00ff00; font-size:12px; margin-bottom:10px; font-family:monospace; font-weight:bold;">
                INVESTIGADOR: ${inv.nome.toUpperCase()}
            </div>
            <div style="display:flex; gap:5px;">
                <button onclick="abrirFicha(${inv.id})" style="flex:2; background:#002244; color:#00aaff; font-size:10px;">CARREGAR</button>
                <button onclick="renomearInvestigador(${inv.id})" style="background:#222; color:#aaa; font-size:10px; padding:0 8px;">‚úé</button>
                <button onclick="removerInvestigador(${inv.id})" style="background:#330000; color:#ff4444; font-size:10px;">X</button>
            </div>
        `;
        lista.appendChild(div);
    });
}


function renomearInvestigador(id) {
    const novoNome = prompt("Digite o novo codinome do Investigador:");
    if(!novoNome || !novoNome.trim()) return;

    const savedData = JSON.parse(localStorage.getItem("CoC_User_" + agenteLogado));
    const inv = savedData.investigadores.find(i => i.id === id);
    if(inv) {
        inv.nome = novoNome.trim();
        localStorage.setItem("CoC_User_" + agenteLogado, JSON.stringify(savedData));
        atualizarListaInvestigadores();
    }
}

function carregarInvestigador(id) {
    const savedData = JSON.parse(localStorage.getItem("CoC_User_" + agenteLogado));
    const inv = savedData.investigadores.find(i => i.id === id);
    if(inv) {
        investigadorAtual = id;
        aplicarDados(inv.ficha);
        alert("Investigador '" + inv.nome + "' carregado!");
    }
}

function removerInvestigador(id) {
    if(!confirm("Tem certeza que deseja remover este investigador?")) return;
    
    const savedData = JSON.parse(localStorage.getItem("CoC_User_" + agenteLogado));
    savedData.investigadores = savedData.investigadores.filter(i => i.id !== id);
    localStorage.setItem("CoC_User_" + agenteLogado, JSON.stringify(savedData));
    
    if(investigadorAtual === id) {
        investigadorAtual = null;
        limparFicha();
    }
    
    atualizarListaInvestigadores();
}

function salvarLocal() {
    if(!agenteLogado) return alert("Fa√ßa login primeiro!");
    
    const savedData = JSON.parse(localStorage.getItem("CoC_User_" + agenteLogado));
    
    if(investigadorAtual) {
        const inv = savedData.investigadores.find(i => i.id === investigadorAtual);
        if(inv) {
            inv.ficha = colherDados();
            localStorage.setItem("CoC_User_" + agenteLogado, JSON.stringify(savedData));
            alert("Investigador '" + inv.nome + "' salvo!");
        }
    } else {
        alert("Selecione ou crie um investigador primeiro!");
    }
}

function limparFicha() {
    document.querySelectorAll('#camposPessoais input').forEach(i => i.value = '');
    todosAtributos.forEach(a => document.getElementById(`input-${a}`).value = '');
    document.getElementById('charPhoto').src = '';
    document.getElementById('charPhoto').style.display = 'none';
    document.getElementById('placeholderTxt').style.display = 'block';
    stats = { PV: { atual: 0, max: 0 }, SAN: { atual: 0, max: 99 }, MAG: { atual: 0, max: 0 } };
    atualizarTudo();
}

function resetarFicha() {
    if(!confirm("Tem certeza que deseja resetar toda a ficha? Esta a√ß√£o n√£o pode ser desfeita!")) return;
    
    // Limpar campos pessoais
    document.querySelectorAll('#camposPessoais input').forEach(i => {
        if(i.id === 'idade') {
            i.value = '25';
        } else {
            i.value = '';
        }
    });
    
    // Resetar atributos
    todosAtributos.forEach(a => document.getElementById(`input-${a}`).value = '');
    
    // Resetar foto
    document.getElementById('charPhoto').src = '';
    document.getElementById('charPhoto').style.display = 'none';
    document.getElementById('placeholderTxt').style.display = 'block';
    historicoFoto = null;
    document.getElementById('btnDesfazer').disabled = true;
    document.getElementById('btnDesfazer').style.opacity = "0.5";
    
    // Resetar stats
    stats = { PV: { atual: 0, max: 0 }, SAN: { atual: 0, max: 99 }, MAG: { atual: 0, max: 0 } };
    
    // Resetar sorte
    document.getElementById('valSORTE').innerText = '-';
    
    // Resetar per√≠cias padr√£o
    listaPericias.forEach(p => {
        const id = p.n.replace(/\s+/g, '-');
        const el = document.getElementById(`p-val-${id}`);
        if(el) {
            el.value = p.v;
            calcP(id);
        }
    });
    
    // Remover per√≠cias customizadas
    document.querySelectorAll('.pericia-custom').forEach(tr => tr.remove());
    
    // Limpar armas
    document.getElementById('weaponBody').innerHTML = '';
    addWeaponRow();
    
    // Limpar dados de rolagem
    document.getElementById('diceDisplay').innerText = 'AGUARDANDO...';
    document.getElementById('diceInput').value = '';
    
    atualizarTudo();
    alert("Ficha resetada com sucesso!");
}

function colherDados() {
    const dados = {
        pessoais: {},
        atributos: {},
        pericias: {},
        periciasCustom: [],
        armas: [],
        stats: stats,
        foto: document.getElementById('charPhoto').src,
        sorte: document.getElementById('valSORTE').innerText
    };
    document.querySelectorAll('#camposPessoais input').forEach(i => dados.pessoais[i.dataset.key] = i.value);
    todosAtributos.forEach(a => dados.atributos[a] = document.getElementById(`input-${a}`).value);
    listaPericias.forEach(p => {
        const id = p.n.replace(/\s+/g, '-');
        const el = document.getElementById(`p-val-${id}`);
        if(el) dados.pericias[id] = el.value;
    });
    
    // Salvar per√≠cias customizadas
    document.querySelectorAll('.pericia-custom').forEach(tr => {
        const inputs = tr.querySelectorAll('input');
        if(inputs.length >= 2) {
            dados.periciasCustom.push({
                nome: inputs[0].value,
                valor: inputs[1].value
            });
        }
    });
    
    document.querySelectorAll('#weaponBody tr').forEach(tr => {
        const inputs = tr.querySelectorAll('input');
        if (inputs.length > 0) dados.armas.push(Array.from(inputs).map(i => i.value));
    });
    return dados;
}

function aplicarDados(dados) {
    if(!dados) return;
    for(let k in dados.pessoais) {
        const el = document.querySelector(`[data-key="${k}"]`);
        if(el) el.value = dados.pessoais[k];
    }
    for(let k in dados.atributos) document.getElementById(`input-${k}`).value = dados.atributos[k];
    for(let k in dados.pericias) {
        const el = document.getElementById(`p-val-${k}`);
        if(el) { el.value = dados.pericias[k]; calcP(k); }
    }
    
    // Carregar per√≠cias customizadas
    if(dados.periciasCustom) {
        dados.periciasCustom.forEach(p => {
            adicionarPericiaCustom(p.nome, p.valor);
        });
    }
    
    if(dados.foto && dados.foto.length > 10) {
        const img = document.getElementById('charPhoto');
        img.src = dados.foto; img.style.display = 'block';
        document.getElementById('placeholderTxt').style.display = 'none';
    }
    stats = dados.stats;
    document.getElementById('valSORTE').innerText = dados.sorte || "-";
    const body = document.getElementById('weaponBody');
    body.innerHTML = "";
    dados.armas.forEach(a => {
        addWeaponRow();
        const lastRow = body.lastElementChild;
        const inputs = lastRow.querySelectorAll('input');
        a.forEach((val, i) => { if(inputs[i]) inputs[i].value = val; });
        calcWeapon(inputs[1]);
    });
    atualizarTudo();
}

function exportarAgente() {
    const dados = colherDados();
    const blob = new Blob([JSON.stringify(dados)], {type: "application/json"});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `FICHA_${agenteLogado}.json`;
    a.click();
}

// --- SEU C√ìDIGO ORIGINAL (MANTIDO INTEGRALMENTE) ---
const m = document.getElementById('bgMusic');
m.volume = 0.1;
window.addEventListener('load', () => { m.play().catch(() => {}); });

const bg = document.getElementById('bg-particles');
for (let i = 0; i < 150; i++) {
    const sq = document.createElement('div');
    sq.className = 'square';
    const size = Math.random() * 15 + 5 + 'px';
    sq.style.width = size; sq.style.height = size;
    sq.style.left = Math.random() * 100 + 'vw';
    sq.style.animationDuration = Math.random() * 10 + 8 + 's';
    sq.style.animationDelay = Math.random() * 15 + 's';
    bg.appendChild(sq);
}

let stats = { PV: { atual: 0, max: 0 }, SAN: { atual: 0, max: 99 }, MAG: { atual: 0, max: 0 } };

function modStatus(tipo, qtd) {
    stats[tipo].atual = Math.min(stats[tipo].max, Math.max(0, stats[tipo].atual + qtd));
    updateBarVisual(tipo);
}

function modStatusMax(tipo, qtd) {
    stats[tipo].max = Math.max(0, stats[tipo].max + qtd);
    if(stats[tipo].atual > stats[tipo].max) {
        stats[tipo].atual = stats[tipo].max;
    }
    updateBarVisual(tipo);
}

function updateBarVisual(tipo) {
    const percent = stats[tipo].max > 0 ? (stats[tipo].atual / stats[tipo].max) * 100 : 0;
    const fillEl = document.getElementById(`fill-${tipo}`);
    if(fillEl) fillEl.style.width = percent + "%";
    document.getElementById(`txt-${tipo}`).innerText = `${stats[tipo].atual} / ${stats[tipo].max}`;
}

function updateBarVisual(tipo) {
    const percent = stats[tipo].max > 0 ? (stats[tipo].atual / stats[tipo].max) * 100 : 0;
    const fillEl = document.getElementById(`fill-${tipo}`);
    if(fillEl) fillEl.style.width = percent + "%";
    document.getElementById(`txt-${tipo}`).innerText = `${stats[tipo].atual} / ${stats[tipo].max}`;
}

let historicoFoto = null;
function carregarFoto(event) {
    const reader = new FileReader();
    const img = document.getElementById('charPhoto');
    reader.onload = () => {
        historicoFoto = img.src;
        document.getElementById('btnDesfazer').disabled = false;
        document.getElementById('btnDesfazer').style.opacity = "1";
        img.src = reader.result; img.style.display = 'block';
        document.getElementById('placeholderTxt').style.display = 'none';
    }
    if(event.target.files[0]) reader.readAsDataURL(event.target.files[0]);
}

function removerFoto() {
    const img = document.getElementById('charPhoto');
    if (img.src && img.style.display !== 'none') {
        historicoFoto = img.src;
        document.getElementById('btnDesfazer').disabled = false;
        document.getElementById('btnDesfazer').style.opacity = "1";
        img.src = ""; img.style.display = 'none';
        document.getElementById('placeholderTxt').style.display = 'block';
    }
}

function desfazerFoto() {
    if (historicoFoto) {
        const img = document.getElementById('charPhoto');
        const fotoAtual = img.src;
        img.src = historicoFoto; img.style.display = 'block';
        document.getElementById('placeholderTxt').style.display = 'none';
        historicoFoto = fotoAtual; 
    }
}

function calcWeapon(input) {
    const row = input.closest('tr');
    const val = parseInt(input.value) || 0;
    const cells = row.querySelectorAll('.val-auto');
    if(cells.length >= 2) {
        cells[0].value = Math.floor(val / 2);
        cells[1].value = Math.floor(val / 5);
    }
}

function addWeaponRow() {
    const body = document.getElementById('weaponBody');
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td><input type="text" placeholder="Arma"></td>
        <td><input type="number" oninput="calcWeapon(this)" placeholder="Reg."></td>
        <td><input type="text" class="val-auto" readonly value="0"></td>
        <td><input type="text" class="val-auto" readonly value="0"></td>
        <td><input type="text" placeholder="1D10"></td>
        <td><input type="text" placeholder="15m"></td>
        <td><input type="text" placeholder="1"></td>
        <td><input type="text" placeholder="6"></td>
        <td><input type="text" placeholder="98"></td>
        <td><button class="btn-remove-weapon" onclick="this.closest('tr').remove()">X</button></td>
    `;
    body.appendChild(tr);
}

const attrTipoA = ["FOR", "CON", "DES", "POD", "APA"]; 
const attrTipoB = ["TAM", "INT", "EDU"]; 
const todosAtributos = [...attrTipoA, ...attrTipoB];
const attrContainer = document.getElementById('attrContainer');

todosAtributos.forEach(attr => {
    attrContainer.innerHTML += `
        <div class="attr-card">
            <label>${attr}</label>
            <input type="number" id="input-${attr}" oninput="atualizarTudo()" min="0">
            <button style="width:100%; margin-top:8px; font-size:9px;" onclick="testarHabilidade('${attr}', document.getElementById('input-${attr}').value)">TESTAR</button>
            <div class="sub-vals">¬Ω: <span id="half-${attr}">0</span> | ‚Öï: <span id="fifth-${attr}">0</span></div>
        </div>
    `;
});

const listaPericias = [
    { n: "Antropologia", v: 1 }, 
    { n: "Armas de Fogo (Pistolas)", v: 20 },
    { n: "Armas de Fogo (Rifles/Espingardas)", v: 20 }, 
    { n: "Arqueologia", v: 1 },
    { n: "Arremessar", v: 20 },
    { n: "Arte e Of√≠cio", v: 5 },
    { n: "Avalia√ß√£o", v: 5 },
    { n: "Charme", v: 15 },
    { n: "Chaveiro", v: 1 }, 
    { n: "Ci√™ncia", v: 1 },
    { n: "Consertos El√©tricos", v: 10 },
    { n: "Consertos Mec√¢nicos", v: 10 }, 
    { n: "Contabilidade", v: 5 },
    { n: "Direito", v: 5 },
    { n: "Dirigir Autom√≥vel", v: 20 }, 
    { n: "Disfarce", v: 5 },
    { n: "Eletr√¥nica", v: 1 },
    { n: "Encontrar", v: 25 },
    { n: "Escalar", v: 20 }, 
    { n: "Escutar", v: 20 },
    { n: "Esquivar", v: 0 }, 
    { n: "Furtividade", v: 20 },
    { n: "Hist√≥ria", v: 20 },
    { n: "Intimida√ß√£o", v: 15 },
    { n: "L√°bia", v: 5 },
    { n: "L√≠ngua (Nativa)", v: 0 },
    { n: "L√≠ngua (Outra)", v: 1 },
    { n: "Lutar (Briga)", v: 25 }, 
    { n: "Medicina", v: 1 },
    { n: "Mythos de Cthulhu", v: 0 },
    { n: "Mundo Natural", v: 10 }, 
    { n: "Nata√ß√£o", v: 10 },
    { n: "Navega√ß√£o", v: 10 },
    { n: "N√≠vel de Cr√©dito", v: 0 },
    { n: "Ocultismo", v: 5 }, 
    { n: "Operar Maquin√°rio", v: 1 },
    { n: "Persuas√£o", v: 10 },
    { n: "Pilotar", v: 1 },
    { n: "Prestidigita√ß√£o", v: 10 },
    { n: "Primeiros Socorros", v: 30 },
    { n: "Psican√°lise", v: 1 },
    { n: "Psicologia", v: 1 },
    { n: "Rastrear", v: 10 }, 
    { n: "Saltar", v: 20 },
    { n: "Sobreviv√™ncia", v: 10 }, 
    { n: "Usar Bibliotecas", v: 20 },
    { n: "Usar Computadores", v: 5 }
];

function renderPericias() {
    const container = document.getElementById('periciasContainer');
    container.innerHTML = "";
    const metade = Math.ceil(listaPericias.length / 2);
    for (let i = 0; i < 2; i++) {
        const table = document.createElement('table');
        table.className = "pericias-table";
        table.innerHTML = `<thead><tr><th>Per√≠cia</th><th>Reg.</th><th>S√≥l.</th><th>Ext.</th><th>üé≤</th></tr></thead><tbody id="p-body-${i}"></tbody>`;
        container.appendChild(table);
        const slice = listaPericias.slice(i * metade, (i + 1) * metade);
        const tbody = document.getElementById(`p-body-${i}`);
        slice.forEach(p => {
            const idSafe = p.n.replace(/\s+/g, '-');
            tbody.innerHTML += `<tr><td style="text-align:left; color:#888;">${p.n}</td><td><input type="number" value="${p.v}" id="p-val-${idSafe}" oninput="calcP('${idSafe}')"></td><td><input type="text" class="val-auto" id="p-half-${idSafe}" readonly value="${Math.floor(p.v/2)}"></td><td><input type="text" class="val-auto" id="p-fifth-${idSafe}" readonly value="${Math.floor(p.v/5)}"></td><td><button style="padding:2px 8px; font-size:10px;" onclick="testarHabilidade('${p.n}', document.getElementById('p-val-${idSafe}').value)">üé≤</button></td></tr>`;
        });
    }
}

function adicionarPericiaCustom(nomePredef = null, valorPredef = null) {
    const nome = nomePredef || prompt("Nome da nova per√≠cia:");
    if(!nome || !nome.trim()) return;
    
    const valor = valorPredef !== null ? valorPredef : (prompt("Valor inicial (0-100):") || "0");
    
    const table = document.querySelector('.pericias-table');
    const tbody = table.querySelector('tbody');
    const tr = document.createElement('tr');
    tr.className = 'pericia-custom';
    
    const idSafe = 'custom-' + Date.now();
    const valorNum = parseInt(valor) || 0;
    
    tr.innerHTML = `
        <td style="text-align:left;"><input type="text" value="${nome}" style="background: transparent; border: none; color: #00ff00; width: 100%;"></td>
        <td><input type="number" value="${valorNum}" id="p-val-${idSafe}" oninput="calcP('${idSafe}')"></td>
        <td><input type="text" class="val-auto" id="p-half-${idSafe}" readonly value="${Math.floor(valorNum/2)}"></td>
        <td><input type="text" class="val-auto" id="p-fifth-${idSafe}" readonly value="${Math.floor(valorNum/5)}"></td>
        <td>
            <button style="padding:2px 8px; font-size:10px;" onclick="testarHabilidade('${nome}', document.getElementById('p-val-${idSafe}').value)">üé≤</button>
            <button class="btn-remove-weapon" onclick="this.closest('tr').remove()" style="margin-left: 3px;">X</button>
        </td>
    `;
    
    tbody.appendChild(tr);
}

function calcP(id) {
    const el = document.getElementById(`p-val-${id}`);
    if(!el) return;
    const val = parseInt(el.value) || 0;
    const halfEl = document.getElementById(`p-half-${id}`);
    const fifthEl = document.getElementById(`p-fifth-${id}`);
    if(halfEl) halfEl.value = Math.floor(val/2);
    if(fifthEl) fifthEl.value = Math.floor(val/5);
}

function testarHabilidade(nome, valorAlvo) {
    const alvo = parseInt(valorAlvo) || 0;
    const roll = Math.floor(Math.random() * 100) + 1;
    const half = Math.floor(alvo / 2); const fifth = Math.floor(alvo / 5);
    const overlay = document.getElementById('result-overlay');
    let title = "FALHA", detail = `${roll} VS ${alvo}`, c="#666", b="#111";
    if (roll === 1) { title="CR√çTICO"; c="#000"; b="#fff"; }
    else if (roll <= fifth) { title="EXTREMO"; c="#fff"; b="#333"; }
    else if (roll <= half) { title="S√ìLIDO"; c="#fff"; b="#666"; }
    else if (roll <= alvo) { title="REGULAR"; c="#000"; b="#999"; }
    else if (roll >= 96 && alvo < 50) { title="DESASTRE"; c="#f00"; b="#300"; }
    else if (roll === 100) { title="DESASTRE"; c="#f00"; b="#300"; }
    document.getElementById('overlay-title').innerText = title;
    document.getElementById('overlay-title').style.color = c;
    document.getElementById('overlay-title').style.backgroundColor = b;
    document.getElementById('overlay-detail').innerText = `${nome.toUpperCase()}: ${detail}`;
    overlay.classList.add('active');
    setTimeout(() => overlay.classList.remove('active'), 2500);
}

function rollXDX(qtd, lados) {
    let total = 0; let rolls = [];
    for (let i = 0; i < qtd; i++) {
        let r = Math.floor(Math.random() * lados) + 1;
        rolls.push(r); total += r;
    }
    return { total, formula: rolls.join(' + ') + ' = ' + total };
}

function rollCustomDice() {
    const input = document.getElementById('diceInput').value;
    const m = input.match(/(\d+)d(\d+)/i);
    if (m) {
        const res = rollXDX(m[1], m[2]);
        document.getElementById('diceDisplay').innerText = res.formula;
    }
}


// Fun√ß√£o para mudar de aba (atualize a sua existente)
function switchTab(tab) {
    document.getElementById('login-form').style.display = (tab === 'login') ? 'block' : 'none';
    document.getElementById('signup-form').style.display = (tab === 'signup') ? 'block' : 'none';
    document.getElementById('sync-form').style.display = (tab === 'sync') ? 'block' : 'none';
    
    // Remove 'active' de todos e coloca no clicado
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
}

// Fun√ß√£o que l√™ o c√≥digo e preenche a ficha
function importarConta() {
    const codigo = document.getElementById('syncCodeInput').value.trim();
    
    if(!codigo.startsWith('COC-')) {
        alert("C√≥digo inv√°lido! Certifique-se de copiar o c√≥digo inteiro come√ßando com COC-");
        return;
    }

    try {
        // Decodifica o c√≥digo (Base64 para JSON)
        const base64 = codigo.substring(4);
        const dadosPuros = decodeURIComponent(escape(atob(base64)));
        const dadosObjeto = JSON.parse(dadosPuros);

        // Salva no LocalStorage do celular como se voc√™ tivesse criado a conta ali
        const chave = 'CoC_User_' + dadosObjeto.u.toLowerCase();
        localStorage.setItem(chave, JSON.stringify(dadosObjeto.d));
        
        alert("‚úÖ Investigador " + dadosObjeto.u + " importado! Agora √© s√≥ fazer login normalmente nesta aba.");
        switchTab('login');
        
    } catch(e) {
        alert("Erro ao processar o c√≥digo. Ele pode estar incompleto.");
    }
}



function atualizarTudo() {
    let v = {};
    todosAtributos.forEach(attr => {
        const el = document.getElementById(`input-${attr}`);
        v[attr] = parseInt(el.value) || 0;
        document.getElementById(`half-${attr}`).innerText = Math.floor(v[attr] / 2);
        document.getElementById(`fifth-${attr}`).innerText = Math.floor(v[attr] / 5);

        calcularPontosOcupacao();
        
        
    });
    const esquivaInput = document.getElementById('p-val-Esquivar');
    if(esquivaInput) {
        const novaEsquiva = Math.floor(v.DES / 2);
        esquivaInput.value = novaEsquiva;
        calcP('Esquivar');
        document.getElementById('valESQUIVA').innerText = novaEsquiva;
    }
    
   // CORRE√á√ÉO: Atualizar PV, SAN e MAG corretamente
const pvAntigo = stats.PV.max;
const podAntigo = stats.SAN.atual; // Guarda o POD antigo
const magAntigo = stats.MAG.max;

stats.PV.max = Math.floor((v.TAM + v.CON) / 10);
stats.SAN.max = 99; // Sanidade m√°xima sempre 99
stats.SAN.atual = v.POD; // Sanidade atual = POD
stats.MAG.max = Math.floor(v.POD / 5);

// Atualizar valores atuais para PV e MAG quando mudarem
if(pvAntigo !== stats.PV.max) {
    stats.PV.atual = stats.PV.max;
}
if(magAntigo !== stats.MAG.max) {
    stats.MAG.atual = stats.MAG.max;
}

// Garantir que atual n√£o exceda o m√°ximo
stats.PV.atual = Math.min(stats.PV.atual, stats.PV.max);
stats.SAN.atual = Math.min(stats.SAN.atual, stats.SAN.max); // N√£o pode passar de 99
stats.MAG.atual = Math.min(stats.MAG.atual, stats.MAG.max);

// Garantir que atual n√£o exceda o m√°ximo
stats.PV.atual = Math.min(stats.PV.atual, stats.PV.max);
stats.SAN.atual = Math.min(stats.SAN.atual, stats.SAN.max);
stats.MAG.atual = Math.min(stats.MAG.atual, stats.MAG.max);
    
    updateBarVisual('PV'); 
    updateBarVisual('SAN'); 
    updateBarVisual('MAG');
    
    const soma = v.FOR + v.TAM;
    let dx = "0";
    let corpo = 0;

    // Tabela Completa de Dano Extra (DX) e Corpo (Build)
    if (soma <= 64) { 
        dx = "-2"; corpo = -2; 
    } else if (soma <= 84) { 
        dx = "-1"; corpo = -1; 
    } else if (soma <= 124) { 
        dx = "0"; corpo = 0; 
    } else if (soma <= 164) { 
        dx = "+1D4"; corpo = 1; 
    } else if (soma <= 204) { 
        dx = "+1D6"; corpo = 2; 
    } else if (soma <= 284) { 
        dx = "+2D6"; corpo = 3; 
    } else if (soma <= 364) { 
        dx = "+3D6"; corpo = 4; 
    } else if (soma <= 444) { 
        dx = "+4D6"; corpo = 5; 
    } else { 
        // Acima de 445 pontos
        dx = "+5D6"; corpo = 6; 
    }

    // Aplica os resultados nos elementos da ficha
    document.getElementById('valDX').innerText = dx;
    document.getElementById('valCorpo').innerText = corpo;

// 2. Pegar a idade atual do input
const idade = parseInt(document.getElementById('idade').value) || 0;

// --- C√ÅLCULO DO MOV BASE (Regra Cthulhu 7ed) ---
let movBase = 8; // Valor padr√£o

// Precisamos dos valores de FOR, DES e TAM que est√£o dentro do objeto 'v'
if (v.FOR < v.TAM && v.DES < v.TAM) {
    movBase = 7;
} else if (v.FOR > v.TAM || v.DES > v.TAM || v.TAM <= 0) { // TAM <= 0 evita bugs se o campo estiver vazio
    movBase = 9;
    // Se FOR e DES forem maiores que TAM, o MOV √© 9. 
    // Se FOR e DES forem iguais a TAM, o MOV √© 8.
} else {
    movBase = 8;
}

// 2. Pegar a idade atual do input
const idadeValor = parseInt(document.getElementById('idade').value) || 0;

// 3. Calcular a penalidade baseada na faixa et√°ria
let penalidadeIdade = 0;
if (idadeValor >= 80) {
    penalidadeIdade = 5;
} else if (idadeValor >= 70) {
    penalidadeIdade = 4;
} else if (idadeValor >= 60) {
    penalidadeIdade = 3;
} else if (idadeValor >= 50) {
    penalidadeIdade = 2;
} else if (idadeValor >= 40) {
    penalidadeIdade = 1;
}

// 4. Aplicar a penalidade (garantindo que o MOV m√≠nimo seja 1)
const movFinal = Math.max(1, movBase - penalidadeIdade);

// 5. Exibir o resultado final no campo correto
const campoMOV = document.getElementById('valMOV');
if (campoMOV) {
    campoMOV.innerText = movFinal;
}

}

function gerarTodosAtributos() {
    attrTipoA.forEach(a => document.getElementById(`input-${a}`).value = rollXDX(3, 6).total * 5);
    attrTipoB.forEach(b => document.getElementById(`input-${b}`).value = (rollXDX(2, 6).total + 6) * 5);
    rolarSorte(); 
    atualizarTudo();
}

function rolarSorte() {
    const sorte = rollXDX(3, 6).total * 5;
    document.getElementById('valSORTE').innerText = sorte;
}

// Monitora o campo de senha em tempo real
document.getElementById('signupPass').addEventListener('input', function() {
    const pass = this.value;

    // Defini√ß√£o dos requisitos
    const checks = {
        "req-length": pass.length >= 6,
        "req-upper": /[A-Z]/.test(pass),
        "req-lower": /[a-z]/.test(pass),
        "req-number": /\d/.test(pass),
        "req-special": /[\W_]/.test(pass)
    };

    // Aplica a classe 'valid' (verde) ou remove (vermelho) para cada item
    for (const [id, isValid] of Object.entries(checks)) {
        const el = document.getElementById(id);
        if (isValid) {
            el.classList.add('valid');
        } else {
            el.classList.remove('valid');
        }
    }
});

// Ajuste na sua fun√ß√£o de cadastro original:
function realizarCadastro() {
    const user = document.getElementById('signupUser').value.trim();
    const pass = document.getElementById('signupPass').value.trim();
    const msg = document.getElementById('login-msg');

    // Verifica se todos os elementos t√™m a classe 'valid'
    const todosValidos = document.querySelectorAll('.req-item.valid').length === 5;

    if(!todosValidos) {
        msg.style.color = "#ff4444";
        msg.innerText = "PREENCHA TODOS OS REQUISITOS DA SENHA";
        return;
    }

    if(localStorage.getItem("CoC_User_" + user)) return msg.innerText = "ESTE INVESTIGADOR J√Å EST√Å REGISTRADO";
    
    const userData = { password: pass, investigadores: [] };
    localStorage.setItem("CoC_User_" + user, JSON.stringify(userData));
    msg.style.color = "#00ff00";
    msg.innerText = "INVESTIGADOR REGISTRADO COM SUCESSO!";
    setTimeout(() => switchTab('login'), 1500);
}

function minimizarPlayer() {
    const player = document.getElementById('playerMusica');
    player.classList.toggle('player-minimizado');
    
    // Altera o s√≠mbolo do bot√£o dependendo do estado
    const btn = player.querySelector('.btn-janelinha');
    if(player.classList.contains('player-minimizado')) {
        btn.innerText = "üóñ"; // S√≠mbolo de expandir
    } else {
        btn.innerText = "üóó"; // S√≠mbolo de janelinha/minimizar
    }
}

function minimizarFichas() {
    const painel = document.getElementById('menu-fichas');
    painel.classList.toggle('panel-minimizado');
    
    const btn = painel.querySelector('.btn-janelinha-fichas');
    if(painel.classList.contains('panel-minimizado')) {
        btn.innerText = "üóñ";
    } else {
        btn.innerText = "üóó";
    }
}

function fazerLogout() {
    if(confirm("Deseja realmente encerrar a sess√£o do Investigador?")) {
        localStorage.removeItem("Agente_Sessao_Ativa"); // Remove a marca√ß√£o do dispositivo
        location.reload(); // Recarrega para voltar √† tela de login
    }
}


// Esta fun√ß√£o roda automaticamente quando a p√°gina abre
window.addEventListener('load', () => {
    const usuarioSalvo = localStorage.getItem("Agente_Sessao_Ativa");

    if (usuarioSalvo && localStorage.getItem("CoC_User_" + usuarioSalvo)) {
        agenteLogado = usuarioSalvo;
        document.getElementById('login-overlay').style.display = "none";
        document.getElementById('menu-fichas').classList.add('active');
        
        atualizarListaInvestigadores();
        
        // --- ADICIONE ESTE BLOCO AQUI ---
        // Espera um pouco para os dados preencherem a tela e calcula
        setTimeout(() => {
            atualizarTudo();
            calcularPontosOcupacao();
            console.log("C√°lculos autom√°ticos aplicados para: " + usuarioSalvo);
        }, 500); 
        // --------------------------------
    }
});


const dadosOcupacoes = {
    "Advogado": { formula: (v) => v.EDU * 4, texto: "EDU √ó 4" },
    "Andarilho": { formula: (v) => (v.EDU * 2) + (Math.max(v.APA, v.DES, v.FOR) * 2), texto: "EDU √ó 2 + [MAIOR ENTRE APA/DES/FOR] √ó 2" },
    "Antiqu√°rio": { formula: (v) => v.EDU * 4, texto: "EDU √ó 4" },
    "Artista": { formula: (v) => (v.EDU * 2) + (Math.max(v.POD, v.DES) * 2), texto: "EDU √ó 2 + [MAIOR ENTRE POD/DES] √ó 2" },
    "Atleta": { formula: (v) => (v.EDU * 2) + (Math.max(v.DES, v.FOR) * 2), texto: "EDU √ó 2 + [MAIOR ENTRE DES/FOR] √ó 2" },
    "Autor": { formula: (v) => v.EDU * 4, texto: "EDU √ó 4" },
    "Bibliotec√°rio": { formula: (v) => v.EDU * 4, texto: "EDU √ó 4" },
    "Clero, Membro do": { formula: (v) => v.EDU * 4, texto: "EDU √ó 4" },
    "Criminoso": { formula: (v) => (v.EDU * 2) + (Math.max(v.DES, v.FOR) * 2), texto: "EDU √ó 2 + [MAIOR ENTRE DES/FOR] √ó 2" },
    "Detetive Particular": { formula: (v) => (v.EDU * 2) + (Math.max(v.DES, v.FOR) * 2), texto: "EDU √ó 2 + [MAIOR ENTRE DES/FOR] √ó 2" },
    "Diletante": { formula: (v) => (v.EDU * 2) + (v.APA * 2), texto: "EDU √ó 2 + APA √ó 2" },
    "Engenheiro": { formula: (v) => v.EDU * 4, texto: "EDU √ó 4" },
    "Fan√°tico": { formula: (v) => (v.EDU * 2) + (Math.max(v.APA, v.POD) * 2), texto: "EDU √ó 2 + [MAIOR ENTRE APA/POD] √ó 2" },
    "Fazendeiro": { formula: (v) => (v.EDU * 2) + (Math.max(v.DES, v.FOR) * 2), texto: "EDU √ó 2 + [MAIOR ENTRE DES/FOR] √ó 2" },
    "Hacker": { formula: (v) => v.EDU * 4, texto: "EDU √ó 4" },
    "Investigador de Pol√≠cia": { formula: (v) => (v.EDU * 2) + (Math.max(v.DES, v.FOR) * 2), texto: "EDU √ó 2 + [MAIOR ENTRE DES/FOR] √ó 2" },
    "Jornalista": { formula: (v) => v.EDU * 4, texto: "EDU √ó 4" },
    "M√©dico": { formula: (v) => v.EDU * 4, texto: "EDU √ó 4" },
    "Membro de Tribo": { formula: (v) => (v.EDU * 2) + (Math.max(v.DES, v.FOR) * 2), texto: "EDU √ó 2 + [MAIOR ENTRE DES/FOR] √ó 2" },
    "Mission√°rio": { formula: (v) => v.EDU * 4, texto: "EDU √ó 4" },
    "M√∫sico": { formula: (v) => (v.EDU * 2) + (Math.max(v.DES, v.POD) * 2), texto: "EDU √ó 2 + [MAIOR ENTRE DES/POD] √ó 2" },
    "Oficial de Pol√≠cia": { formula: (v) => (v.EDU * 2) + (Math.max(v.DES, v.FOR) * 2), texto: "EDU √ó 2 + [MAIOR ENTRE DES/FOR] √ó 2" },
    "Oficial Militar": { formula: (v) => (v.EDU * 2) + (Math.max(v.DES, v.FOR) * 2), texto: "EDU √ó 2 + [MAIOR ENTRE DES/FOR] √ó 2" },
    "Parapsic√≥logo": { formula: (v) => v.EDU * 4, texto: "EDU √ó 4" },
    "Piloto": { formula: (v) => (v.EDU * 2) + (v.DES * 2), texto: "EDU √ó 2 + DES √ó 2" },
    "Professor": { formula: (v) => v.EDU * 4, texto: "EDU √ó 4" },
    "Profissional de Entretenimento": { formula: (v) => (v.EDU * 2) + (v.APA * 2), texto: "EDU √ó 2 + APA √ó 2" },
    "Soldado": { formula: (v) => (v.EDU * 2) + (Math.max(v.DES, v.FOR) * 2), texto: "EDU √ó 2 + [MAIOR ENTRE DES/FOR] √ó 2" }
};

// Fun√ß√£o para calcular os pontos baseada na ocupa√ß√£o atual
function calcularPontosOcupacao() {
    const inputOcupa = document.getElementById('input-ocupacao');
    const display = document.getElementById('display-pontos-ocupacao');
    const formulaLabel = document.getElementById('formula-usada');

    if (!inputOcupa || !display) return;

    const nomeOcupacao = inputOcupa.value;
    const ocupacao = dadosOcupacoes[nomeOcupacao];

    if (ocupacao) {
        // CORRE√á√ÉO DOS IDS: Usando o padr√£o 'input-NOME' que voc√™ definiu no renderizador
        const atributos = {
            FOR: parseInt(document.getElementById('input-FOR')?.value) || 0,
            DES: parseInt(document.getElementById('input-DES')?.value) || 0,
            EDU: parseInt(document.getElementById('input-EDU')?.value) || 0,
            APA: parseInt(document.getElementById('input-APA')?.value) || 0,
            POD: parseInt(document.getElementById('input-POD')?.value) || 0,
            TAM: parseInt(document.getElementById('input-TAM')?.value) || 0
        };

        console.log("Valores reais encontrados para c√°lculo:", atributos);

        const pontos = ocupacao.formula(atributos);
        display.innerText = pontos;
        
        if (formulaLabel) formulaLabel.innerText = ocupacao.texto;
        console.log("Sucesso! Pontos calculados:", pontos);
    } else {
        display.innerText = "0";
        if (formulaLabel) formulaLabel.innerText = "SELECIONE UMA OCUPA√á√ÉO";
    }
}


// ====================================
// MOTOR DE SINCRONIZA√á√ÉO VIA TOKEN
// ====================================

function gerarCodigoDeConta() {
    const usuario = agenteLogado; // Pega o usu√°rio que est√° logado no momento
    const dadosLocais = localStorage.getItem('CoC_User_' + usuario);
    
    if (!dadosLocais) {
        alert("Erro: Dados de conta n√£o encontrados.");
        return;
    }

    const pacoteConta = {
        u: usuario,                 // Nome de usu√°rio
        p: JSON.parse(dadosLocais).password, // Senha
        d: JSON.parse(dadosLocais), // Todos os dados (fichas, etc)
        v: "1.0"                    // Vers√£o do sistema
    };

    // Transforma em c√≥digo COC-
    const jsonStr = JSON.stringify(pacoteConta);
    const token = "COC-" + btoa(unescape(encodeURIComponent(jsonStr)));

    // Exibe o c√≥digo
    const areaCodigo = document.getElementById('user-sync-code');
    if (areaCodigo) {
        areaCodigo.innerText = token;
    } else {
        prompt("COPIE SEU C√ìDIGO DE CONTA:", token);
    }
}

function importarConta() {
    const codigo = document.getElementById('syncCodeInput').value.trim();
    
    if(!codigo.startsWith('COC-')) {
        alert("‚ö†Ô∏è C√≥digo inv√°lido! O c√≥digo deve come√ßar com 'COC-'");
        return;
    }

    try {
        // 1. Decodifica o c√≥digo
        const base64 = codigo.substring(4);
        const jsonStr = decodeURIComponent(escape(atob(base64)));
        const conta = JSON.parse(jsonStr);

        // 2. Valida se o c√≥digo tem as informa√ß√µes de conta (Usu√°rio e Senha)
        if (!conta.u || !conta.p) {
            alert("‚ùå Este c√≥digo cont√©m apenas dados de uma ficha, n√£o da conta completa.");
            return;
        }

        // 3. Salva a conta no banco de dados local (LocalStorage) do celular
        const chave = 'CoC_User_' + conta.u.toLowerCase();
        localStorage.setItem(chave, JSON.stringify(conta.d));
        
        alert(`‚úÖ CONTA IMPORTADA!\nUsu√°rio: ${conta.u}\n\nAgora voc√™ j√° pode fazer login com sua senha.`);
        
        // 4. Limpa e volta para a aba de login
        document.getElementById('syncCodeInput').value = "";
        switchTab('login');

    } catch(e) {
        console.error(e);
        alert("‚ùå Falha cr√≠tica: O c√≥digo est√° incompleto ou corrompido.");
    }
}



let scrollPosicaoOriginal = 0;

function abrirModalOcupacoes() {
    // Salva a posi√ß√£o atual
    scrollPosicaoOriginal = window.pageYOffset || document.documentElement.scrollTop;
    
    const modal = document.getElementById('modal-ocupacoes');
    const grid = document.getElementById('lista-ocupacoes-grid');

    // Preenche o grid (Garante que dadosOcupacoes existe)
    if (typeof dadosOcupacoes !== 'undefined') {
        grid.innerHTML = "";
        Object.keys(dadosOcupacoes).forEach(ocupa => {
            const btn = document.createElement('button');
            btn.className = 'btn-ocupacao-item';
            btn.innerText = ocupa;
            btn.onclick = () => selecionarOcupacao(ocupa);
            grid.appendChild(btn);
        });
    }

    modal.style.display = 'flex';

    // Trava o scroll
    document.body.style.overflow = 'hidden';
    document.body.style.position = 'fixed';
    document.body.style.top = `-${scrollPosicaoOriginal}px`;
    document.body.style.width = '100%';
}

function fecharModalOcupacoes() {
    const modal = document.getElementById('modal-ocupacoes');
    if (modal) modal.style.display = 'none';

    // DESTRAVA o scroll limpando todas as propriedades
    document.body.style.removeProperty('overflow');
    document.body.style.removeProperty('position');
    document.body.style.removeProperty('top');
    document.body.style.removeProperty('width');

    // Volta para a posi√ß√£o onde o usu√°rio estava
    window.scrollTo(0, scrollPosicaoOriginal);
}

function selecionarOcupacao(nome) {
    const input = document.getElementById('input-ocupacao');
    
    if (input) {
        input.value = nome;
        console.log("Ocupa√ß√£o selecionada:", nome);

        // Fecha o modal e limpa o scroll
        fecharModalOcupacoes();

        // FOR√áA O C√ÅLCULO IMEDIATO
        calcularPontosOcupacao();

        // Dispara evento para salvar no localStorage (se voc√™ usar)
        input.dispatchEvent(new Event('input'));
    } else {
        console.error("Erro: N√£o encontrei o campo 'input-ocupacao'!");
    }
}

function switchTab(tab) {
    // Lista de IDs dos formul√°rios
    const forms = ['login-form', 'signup-form', 'sync-form'];
    
    // Esconder todos
    forms.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
    });

    // Mostrar o selecionado
    const targetForm = document.getElementById(tab + '-form');
    if (targetForm) targetForm.style.display = 'block';

    // Gerenciar classe ativa nos bot√µes
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    
    // Adiciona active no bot√£o que foi clicado
    event.currentTarget.classList.add('active');
    
    // Limpar mensagens de erro ao trocar
    document.getElementById('login-msg').innerText = '';
}


// Inicializa√ß√£o (Certifique-se que estas linhas existam e estejam fora de outras fun√ß√µes)
renderPericias();
if (typeof addWeaponRow === "function") addWeaponRow(); 
atualizarTudo();



renderPericias();
addWeaponRow(); 
atualizarTudo();
</script>
</body>
</html>
